var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.common = com.grupopinero.octopus.packages.common || {};
com.grupopinero.octopus.packages.common.Utils = (function(){
	'use strict'
	
    var api = {
    		routes: __getRoutes,
	};
    return api;
	
	function __getRoutes() {
		var base = '/package/process/';
		var parentBase = com.grupopinero.common.Globals.options.isLogged 
			? '/b2b/'
			: '/b2c/';
		parentBase += 'slt/';
			
		return {
			home : base + 'home/Home',
			availability : {
				availability : base + 'availability/Availability',
				filter       : base + 'availability/AvailabilityFilter',
				flights      : base + 'availability/AvailabilityFlights',
				changeFlight : base + 'availability/ChangeAvailabilityFlight',
				calendar     : base + 'availability/FlightsCalendar',
				checkAllowedSelling     : base + 'availability/CheckAllowedSelling',
				loadOrigins : base + 'availability/GetDestinationOrigins',
				loadAvailableMonths : base + 'availability/GetAvailableMonths',
				trace : base + 'availability/Trace',
				delayed : base + 'availability/AvailabilityDelayed'
			},
			hotel : base + 'hotel/HotelDetails',
			quote : {
				quote 				: base + 'quote/Quote',
				print 				: base + 'quote/Print',
				send  				: base + 'quote/Send',
				createExpedient 	: base + 'quote/CreateExpedient',
				immediatePaymentSlt : '/b2b/slt/pagos/PagoReservaAddonHpp',
				immediatePaymentCo2	: '/coming2/reservas/pagos/PagoReservaAddonHpp',
				updateOptionalService : base + 'quote/UpdateOptionalService',
				delayedQuote : base + 'quote/DelayedQuote'
			},
			book : {
				book  		 : base + 'book/Book',
				saveBudget	 : base + 'book/SaveBudget',
				print 		 : base + 'book/Print',
				send  		 : base + 'book/Send',
				excursionsCrossSelling : '/excursion/process/availability/Availability'
			},
			caches : {
				caches : base + '/caches/CacheManager',
				refresh : base + '/caches/CacheRefresh'
			},
			legal : {
				load : parentBase + 'legal/LegalAjax',
			}
		};
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.quote = com.grupopinero.octopus.packages.quote || {};
com.grupopinero.octopus.packages.quote.Quote = (function(){
	'use strict'
	
	let __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils,
		modals: com.grupopinero.octopus.helper.common.Modals
	};
	
	let api = {
		options : {
			sorryImage : 'https://static.grupo-pinero.com/web-static/images/sorry3.png'
		},
		init : __init,
		immediatePaymentCallback : __immediatePaymentCallback,
		initAfterDelayed : __initAfterDelayed
	}
	
	let __private = {
	    DISPLAY_DATE_FORMAT : "DD/MM/YYYY",
	    DATE_FORMAT : "YYYY-MM-DD",
		$form : $('form#bookForm'),
		$emailForm : $('form#sendEmailForm'),
		immediatePaymentWindow : undefined,
		immediatePaymentSubmitRq : undefined,
		currentExpedientRequest : {
			xhr : undefined,
			timeout : undefined,
			expired : true
		},
		EXPEDIENT_VALIDATION_EXPIRATION_TIME : 500
	};
	
	let priceInterval;
	
	let fromPage;
	
	return api;
	
	function __init(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);
		
		//inicialización del desglose
		__initBreakdown();
		//inicialización resumen
		__initSummary();
		//inicialización eventos pasajeros
		__initPassengers();
		//inicializacion eventos equipaje
		__initBaggage();
		//inicializacion eventos extras golf
		__initGolf();
		//inicializacion del submit
		__initSubmit();
		//comprueba si el vuelo tiene disponibilidad real
		__checkFlightPrebooking();
		//comprueba si el vuelo ha cambiado de precio
		__checkFlightPriceChanged();
		//comprueba si es hotel en RQ con vuelo de emisión directa
		__checkHotelRqWithInmediateIssue();
		//comprueba si el expediente es válido 
		__onGetExpedientValue();
		//inicializacion enlaces politicas
		__initLegalModal();
		
		//Initializa validaciones
		__initCustomValidations();
		
		__initDelayedQuote();

	}
	
	function __initAfterDelayed(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);
		
		__import.utils.app.init('#quoteContent');
		__private.$form = $('form#bookForm'),
		__private.$emailForm = $('form#sendEmailForm');
		__toggleBreakdowns();
		__setBreakdownView('gross');
		//inicializa el popup de enviar correo
		$('.js-send-mail').magnificPopup({
		  type:'inline',
		  midClick: true
		});
		__private.$emailForm.on('submit', function( event ){
			event.preventDefault();
			__submitEmailForm(this);
		});
		__initSummary();
		__initPassengers();
		__initBaggage();
		__initSubmit();
		//comprueba si el vuelo tiene disponibilidad real
		__checkFlightPrebooking();
		//comprueba si el vuelo ha cambiado de precio
		__checkFlightPriceChanged();
		//comprueba si es hotel en RQ con vuelo de emisión directa
		__checkHotelRqWithInmediateIssue();
		//comprueba si el expediente es válido 
		__onGetExpedientValue();
		__initLegalModal();
		__initCustomValidations();
	}
	
	/**
	 * Validate client expedient on put it inside the form input value
	 */
	function __onGetExpedientValue() { 
		$(document.body).on('input', '.js-validate-expedient', function(){
			let rq = __serializeForm(__private.$form);
			rq.clientCode = $('input[name="clientCode"]').val();
			rq.branchOfficeCode =  $('input[name="branchOfficeCode"]').val();
			let url = __import.webUtils.routes().book.book;
			rq.validationType = 'expedient';

			if (__private.currentExpedientRequest.expired) {
				__private.currentExpedientRequest.expired = false;
				/* [Julio Martinez][01-08-2018] Aborta la petición anterior si ya habia una */
				if ( __private.currentExpedientRequest.xhr && __private.currentExpedientRequest.xhr.readystate != 4 ) {
					__private.currentExpedientRequest.xhr.abort();
				}
				/* [Julio Martinez][01-08-2018] Se pone un timeout hasta que se pueda volver a sobreescribir la petición */
				__private.currentExpedientRequest.timeout = setTimeout(function() {
					__private.currentExpedientRequest.expired = true;
				}, __private.EXPEDIENT_VALIDATION_EXPIRATION_TIME);
				__private.currentExpedientRequest.xhr = __import.utils.forms.validateRequest(rq, url, __private.$form, __onGetExpedientValueCallback, 'validity');
			}
		});
	}
	
	/**
	 * Borra el validity de expediente en el callback de la validacion
	 */
	function __onGetExpedientValueCallback(response) {
		if (response && response.result && response.result.ok ) {
			let dom =  __private.$form.find('.js-validate-expedient').get(0);
			dom.setCustomValidity('');
			dom.checkValidity();
		}
	}
	
	/**
	 * Inicializa los eventos asociados con el desglose
	 */
	function __initBreakdown() {
		__toggleBreakdowns();
		
		$(document.body).on('change','[id=breakdownView_complete]', function(){
			__toggleBreakdowns();
		});
		$(document.body).on('change','[name=breakdownView]', function(){
			__setBreakdownView($(this).val());
		});
		$(document.body).on('click', '.js-print-quote', function() {
			__printQuote();
		});
		
		//inicializa el popup de enviar correo
		$('.js-send-mail').magnificPopup({
		  type:'inline',
		  midClick: true
		});
		__private.$emailForm.on('submit', function( event ){
			event.preventDefault();
			__submitEmailForm(this);
		});
		__setBreakdownView('gross');
	}
	
	function __toggleBreakdowns(){
		$(document.body).find('.js-breakdown-row').each(function(){
			let $this = $(this);
			let detailed = $this.data().detailed;
			if( detailed != undefined)
			{ 
				if( detailed ){
					$this.addClass('u-display-none');
					$this.data().detailed = false;
				}else if(!detailed){
					$this.removeClass('u-display-none');
					$this.data().detailed = true;
				}
			}
		});
	}
	
	/**
	 * Cambia la vista del desglose
	 */
	function __setBreakdownView( value ) {
		let $netColumns = $('.js-net-column');
		api.options.breakdown = value;
		if (value == 'gross') {
			$netColumns.hide();
		} else if (value == 'net') {
			$netColumns.show();
		}
		__calculateBreakdownTotals();
	}
	
	/**
	 * Actualiza los totales del desglose con la suma de las columnas visibles
	 */
	function __calculateBreakdownTotals() {
		$('.js-breakdown-total').each(function(){
			let column = $(this).data('column');
			if (column) {
				let total = 0;
				$('.js-breakdown-row:not(.u-display-none) .js-breakdown-column[data-column="'+column+'"]').each(function(){
					total += parseFloat($(this).data('value')) || 0;
					total += parseFloat($(this).find('[data-luggage-total]').data('luggageTotal') || 0);
				});
				$(this).html( total ).formatCurrency({ region: __getLocale($(this).data().currency) });
			}
		})
	}
	
	function __getLocale(currency) {
		var result;
		switch (currency) {
		case 'USD':
			result = 'en-US';
			break;
		case 'EUR':
		default:
			result = 'es-ES';
			break;
		}
		return result;
	}
	
	/**
	 * Inicializa los eventos asociados con el resumen de la formalización
	 */
	function __initSummary() {
		$(document.body).on('change','.js-toggle-from-quote-summary', function() {
			let $this = $(this);
			__toggleFromQuoteSummary($this);
			if ($this.data('isDynamic') == true) {
				__updateOptionalService($this);				
			}
		});
		$(document.body).on('click','.js-go-back', function(){
		
			// [Sergio Larios][16-26-21] Si ha habido un problema con el vuelo eso significa que se ha
			// borrado la cache y ya no hay un availToken que podamos usar, por ello debemos lanzar un nuevo
			// avail solo si se ha dado este caso
			// [JMC][11-04-22] STPIER-326 Cuando se filtra y se vuelve atrás se visualiza lo filtrado sin indicarlo en los filtros
			//Se modifica para que siempre es vuelva a hacer una disponibilidad siempre
//			if (api.options.flightPriceChanged) {
			   var rq_data = $(this).data();
			
				var rq = api.options.availRq;
				//if (rq_data.frompage == 'HOME') {
				 // rq.fromPage = 'SEARCHER';
				//}else{
			   // rq.fromPage = 'OTHERS';
				//}
				rq.fromPage = rq_data.fromPage;
				rq.fromCache = true;
				rq.availToken = rq_data.availToken;
				__import.utils.spinner.show();
				__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
				return;
//			}
		
//			var rq = $(this).data();
			
			//[Julio Martinez][07-11-2018] Hay que eliminar el sufijo de Bahia Principe
			//Si se trata de un budget de la dispo especial para estos hoteles
			
//			var hotelsTab = rq.tab;
			
//			if (_.endsWith(rq.availToken, '-BP')) {
//				hotelsTab = 'hotels-bp';
//			}
			
//			if (rq.tab == 'flights') {
//				rq.previousTab = hotelsTab;
//			} else {
//				rq.tab = hotelsTab;
//			}
			
//			rq.availToken = rq.availToken.replace(/-BP$/g,'');
//			
//			__import.utils.spinner.show();
//			__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
		});
	}
	
	/**
	 * Al cambiar el valor de un checkbox, alterna un elemento opcional del resumen, cambiando el precio final y el desglose
	 */
	function __toggleFromQuoteSummary( $element ) {
		let checked = $element.is(':checked');
		let code = $element.data('code');
		let summaryType = $element.data('summaryType');
		let price = parseFloat($element.data('price')).toFixed(2);
		__updateTotalAmount();
		
		let $row = $('.js-optional-service[data-summary-type='+summaryType+'][data-code="'+code+'"]');
		if (summaryType == 'transfer') {
			let toHotel = !!$('.js-toggle-from-quote-summary[data-summary-type='+summaryType+'][data-code^="AH"]:checked').length;
			let toAirport = !!$('.js-toggle-from-quote-summary[data-summary-type='+summaryType+'][data-code^="HA"]:checked').length;
			let description = $element.data('description');
			
			$('.js-summary-hotel-transfer').find('.js-summary-collective-transfer').toggleClass('u-display-none',toHotel);
			$('.js-summary-hotel-transfer').find('.js-summary-private-transfer').toggleClass('u-display-none',!toHotel);
			$('.js-summary-airport-transfer').find('.js-summary-collective-transfer').toggleClass('u-display-none',toAirport);
			$('.js-summary-airport-transfer').find('.js-summary-private-transfer').toggleClass('u-display-none',!toAirport);
			
			let popoverContainer = code.indexOf('AH') == 0 ? '.js-summary-hotel-transfer' : '.js-summary-airport-transfer';  
			$(popoverContainer)
				.find('.js-summary-transfer-popover')
				.html( description );
			
			if ($element.data('isDynamic') == 'true') {
				__updateTransferCancelTotals( checked, $element.data('price') );
			}
		}
		if(summaryType == 'golf')
		{
			$row.find('.js-breakdown-column').data('value', price);
			$row.find('.js-breakdown-column').html(price + '&nbsp;&euro;');
		}		
		
		$row.toggleClass('u-display-none',!checked);
		__toggleSummaryContainers();
		__calculateBreakdownTotals();
	}
	
	/**
	 * Actualiza el total de gastos de cencelación del traslado
	 */
	function __updateTransferCancelTotals( checked, addPrice ) {
		$('.js-cacellationCharges-transfer').each(function() {
			let newPrice;
			let price = this.innerHTML.match(/<strong>\d+\,?\d*<\/strong>/g)[0];
			price = parseFloat(price.substring(8, price.length-9).replace(',','.'));
			if( checked )
			{
				newPrice = '<strong>'+(price + parseFloat( addPrice )).toString().replace('.',',')+'</strong>';
			}
			else
			{
				newPrice = '<strong>'+(price - parseFloat( addPrice )).toString().replace('.',',')+'</strong>';
			}
			this.innerHTML = this.innerHTML.replace(/<strong>\d+\,?\d*<\/strong>/g, newPrice);
		});
	}
	
	/**
	 * Al cambiar el valor de un checkbox, actualiza el presupuesto para añadir o quitar el servicio opcional
	 */
	function __updateOptionalService($element, updateRq, callback) {

		let rq;
		if(updateRq)
		{
			rq = {
				availToken : api.options.availToken,
				serviceId : updateRq.id,
				addService : updateRq.addService,
				passengers : updateRq.passengers,
				destinationCode : api.options.availRq.destinationCode
			}; 	
		} else
		{
			rq = {
				availToken : api.options.availToken,
				serviceId : $element.data('code'),
				addService : $element.is(':checked'),
				destinationCode : api.options.availRq.destinationCode
			};
		}
		__import.utils.spinner.show();

		try {
			$.ajax({
				type : 'post',
				url : __import.webUtils.routes().quote.updateOptionalService,
				data : {
					rq : JSON.stringify(rq)
				},
				dataType : 'json',
				success : function(response) {
					__import.utils.spinner.hide();
					if(response.result.ok)
					{
						if(callback)
						{
							callback($element);							
						}
					}else 
					{
						$element.prop('checked','');
						__import.utils.notifications.toast(response.result.errorMessage);
					}
				},
				error : function(response) {
					__import.utils.spinner.hide();
					__import.utils.notifications.toast(response.result.errorMessage);
				},
			});
		} catch (e) {
			__import.utils.spinner.hide();
		}
	}
	
	/**
	 * Alterna los contenedores del resumen según tengan elementos visibles o se queden vacíos
	 */
	function __toggleSummaryContainers() {
		var $insuranceContainer = $('.js-optional-services-container').filter(function() {
			return $(this).find('.js-optional-service[data-summary-type="insurance"]').length > 0;
		});

		if ($insuranceContainer.length && $insuranceContainer.find('.js-optional-service:not(.u-display-none)').length) {
			$insuranceContainer.removeClass('u-display-none');
		}

		$('.js-optional-services-container:not(.js-dont-hide)').not($insuranceContainer).each(function() {
			if($(this).find('.js-optional-service:not(.u-display-none)').length) {
				$(this).removeClass('u-display-none');
			} else {
				$(this).addClass('u-display-none');
			}
		});
	}
	
	/**
	 * Inicializa los eventos asociados con el listado de pasajeros
	 */
	function __initPassengers() {
		$('.js-toggle-copy-holder').on('change', function() {
			__toggleCopyHolder(this);
		});
	}
	
	/**
	 * Alterna el evento de copiar el titular al primer pasajero según el valor del checkbox
	 */
	function __toggleCopyHolder(element) {
		let $toggleElements = $('.js-copy-to-first-passenger');
		
		if ($(element).is(':checked')) {
			$toggleElements.on('input', function() {
				let name = $(this).data('name');
				$('.js-copy-holder[data-name='+ name +']').val( $(this).val() );
			});
			$toggleElements.trigger('input');
		} else {
			$toggleElements.off('input');
		}
	}
	
	/**
	 * Inicialización del submit
	 * @returns
	 */
	function __initSubmit() {
		let $form = __private.$form; 
		$('.js-submit-form').click(function() {
			//[TTOED-121][Julio Martinez][25-04-2018] Si no se dispara así, la validación por HTML5 es ignorada
			$('.js-submit-form').prop('disabled', true);
			var $this = $(this);
			__import.utils.spinner.show();
			$.when( $.post( __import.webUtils.routes().availability.checkAllowedSelling, null) )
			.then(function( response, textStatus, jqXHR ) {
				if (response && response.result && response.result.ok ) {		
					var rq = $this.data();
					__import.utils.spinner.hide();
					__checkHotelRqWithInmediateIssueAlert();
					$form.find('input[type=submit]').trigger('click');
				} else {
					__import.utils.spinner.hide();
					__showNotAllowedSellingDialog(response.result.errorMessage);
				}
			});
		});
		document.addEventListener('invalid', function(e){
			$('.js-submit-form').prop('disabled', false);
		}, true);
		
		$form.on('submit', function( event ){
			event.preventDefault();
			__submitForm(this);
		});
	}
	
	function __showNotAllowedSellingDialog(errorText)
	{
		var dialog = { 
			text: errorText, 
			buttons : [ 
			{ 
					label : 'OK', 
					dismiss : true 
			}]
		};
		__import.modals.dialog(dialog);
	}
	
	/**
	 * Accion de submit
	 */
	function __submitForm(form) {
      let rq = __serializeForm(form);
      rq.breakdownView = api.options.breakdown;
      var correctAge = true;

      // Get the current date in localDate format
      let localDate = new Date().toISOString().split('T')[0];

      // Check the birthDay field in rq.rooms.passengers
      if (rq.rooms && Array.isArray(rq.rooms)) {
        rq.rooms.forEach(room => {
          if (room.passengers && Array.isArray(room.passengers)) {
            room.passengers.forEach(passenger => {
              if (passenger.birthDay) {	        	  
                var age = __ageCalculate(moment(passenger.birthDay,  __private.DISPLAY_DATE_FORMAT), localDate);
                if (passenger.age != age) {
                  correctAge = false;
                }
              }
            });
          }
        });
      }

      let webType = api.options.webType || 'B2B';
      if (webType == 'B2C') {
        __submitSaveBudgetForm(rq);
      } else {
        if (correctAge) {
          __submitBookForm(rq);
        } else {
          __import.utils.notifications.toast('La fecha de nacimiento debe coincidir con la edad del pasagero.', 'error');
          $('.js-submit-form').prop('disabled', false);
        }
      }
    }
	
	function __ageCalculate(date, startDate) {
	    var today = buildDate(startDate);
	    var birthday = new Date(date);
	    var age = today.getFullYear() - birthday.getFullYear();
	    var m = today.getMonth() - birthday.getMonth();

	    if (m < 0 || (m === 0 && today.getDate() < birthday.getDate())) {
	    	age--;
	    }

	    return age;
	}
	
	function buildDate(date){
		var year   = parseInt(date.substring(0,4));
		var month  = parseInt(date.substring(5,7));
		var day   = parseInt(date.substring(8,10));
		var dateF = new Date(year, month-1, day);
		return dateF;
	}
	
	/**
	 * Accion del submit para el caso de reserva
	 */
	function __submitBookForm(rq) {
		let url = __import.webUtils.routes().book.book;

		//verificar si los datos de passajeros estan duplicados
		__checkDuplicatedNames(rq, function(result) {
			if (result) {
				rq.validationType = null;
				__import.utils.spinner.show();
				__import.utils.forms.validateRequest(rq, url, __private.$form, function(response) {
					if (response && response.result && response.result.ok ) {
						//Si es agencia prepago y es pago inmediato
						if (api.options.immediatePaymentParams !== undefined && api.options.immediatePaymentParams !== null) {
							__startImmediatePayment( rq, api.options.immediatePaymentParams );
						} else {
							__import.utils.forms.submitRequestForm( rq, url);
						}
					} else {
						$('.js-submit-form').prop('disabled', false);
						__import.utils.spinner.hide();
					}
				});
				
			}
		});
	}
	
	/**
	 * Accion del submit para el caso de guardar presupuesto
	 */
	function __submitSaveBudgetForm(rq) {
		let url = __import.webUtils.routes().book.saveBudget;
		__import.utils.spinner.show();
		__import.utils.forms.submitRequestForm( rq, url );
	}
	
	/**
	 * Accion de submit del formulario de envio de mail
	 */
	function __submitEmailForm(form) {
		//recoge el formulario de booking y lo extiende con los datos del formulario de email
		let emailRq = __serializeForm(form);
		let rq = __serializeForm(__private.$form)
		rq = $.extend(true, rq, emailRq);
		//la vista de netos/brutos se saca del radio no asociado a ningún form
		rq.breakdownView = api.options.breakdown;
		__import.utils.spinner.show();
		
		$.post( __import.webUtils.routes().quote.send, 
			{ rq: JSON.stringify( rq ) }, 
			function __defaultValidationCallback( response ) {
				__import.utils.spinner.hide();
				let message;
				let style;
				if ( response && response.result && response.result.ok ) {
					message = 'Correo enviado con éxito';
					style = 'success';
				} else {
					message = response && response.result && response.result.errorMessage ? response.result.errorMessage : 'Ocurrió un error inesperado';
				}
				__import.utils.notifications.toast( message, style );
			}, 'json' );
	}
	
	/**
	 * Verifica si los nombres de los pasajeros estan duplicados
	 */
	function __checkDuplicatedNames(rq, callback){
		let url = __import.webUtils.routes().book.book; 
		rq.validationType = 'namesAndResidentDocuments';
		__import.utils.forms.validateRequest(rq, url, __private.$form, __onGetPassengersValueCallback, __doPassengerCustomValidation );
		
		/**
		 * Callback de la validacion de nombres duplicados. Está anidada para poder llamar al callback
		 */
		function __onGetPassengersValueCallback(response) {
			let result;
			if (response && response.result && !response.result.ok && !__private.checkedPassengersName) {
				//Si el resultado no es ok, mostramos el modal
				__import.utils.spinner.hide();
				__passengerDuplicatedNameModal(response.data);
			}else{
				result = true;
			}
			$('.js-submit-form').prop('disabled', false);
			callback(result);
		}
	}
	
	/**
	 * Focus en campo nombre pasajero
	 */
	function __doPassengerCustomValidation(form, key, value, response) {
		if (form && key && response && response.data) {
			let $element = $(form).find('[name="'+key+'"],[data-error-name="'+key+'"]');
			response.data.info = value;
			response.data.input = $element;
		}
	}
	
	/**
	 * Muestra un modal de nombre de pasajeros duplicados
	 */
	function __passengerDuplicatedNameModal(response) {
        let dialog = {
            image : '/sltwww/st4/desktop/images/common/sorry3.png',
            text: response.info,
            buttons : [
                {
                    label : api.literals['COMMON.GO_BACK'],
                    events : {
                        click : function () {
                            response.input.focus();
                        }
                    },
                     dismiss : true
                },
                { label : api.literals['COMMON.CONTINUE'],
                    events : {
                        click : function () {
                            __private.checkedPassengersName = true;
                        }
                    },
                dismiss : true } ] };
        __import.modals.dialog(dialog);
	}
	
	/**
	 * Convierte los datos del form en el objeto JSON a validar y enviar al controlador
	 */
	function __serializeForm(form) {
		let result = $(form).serializeJSON({
			useIntKeysAsArrayIndex : true,
			parseNumbers : true,
			skipFalsyValuesForTypes: ["string"]
		});
		
		return result;
	}
	
	/**
	 * Inicializa los eventos relacionados con el equipaje
	 * @returns
	 */
	function __initBaggage() {
		$('.js-change-summary-baggage').on('change', function() {
		    //Desde el componente se copia a este valor para pasarlo al modelo de datos
		    //Para no cambiar el componente JavaScript se hace aquí
		    var luggage = $(this).data("luggage");
		    var luggageItem = $(this).data("luggage-item");
		    var luggageItemCode = $('[data-luggage="' + luggage + '"][data-luggage-item="' + luggageItem + '"][data-luggage-item-code]').val();
		    var s = $('[data-luggage-code="' + luggageItemCode + '"][data-luggage-option="' + luggageItem + '"][data-luggage="' + luggage + '"]').data("luggage-provider-code");
		    $('[data-luggage="' + luggage + '"][data-luggage-item="' + luggageItem + '"][data-luggage-item-provider-code]').val(s)
			__updateTotalAmount();
		});
		$('.js-breakdown-baggage [data-luggage-total]').on('change', function() {
			let currentTotal = parseFloat( $(this).data('luggageTotal')) || 0;
			$(this).closest('.js-breakdown-baggage').toggleClass('u-display-none', !currentTotal );
			__calculateBreakdownTotals();
		});
	}

	/**
	 * Inicializa los eventos relacionados con el equipaje
	 * @returns
	 */
	function __initGolf() {
		$('.js-extra-golf-select').on('click', function(e) {
			e.preventDefault();
		});
		$('input[name="optionalGolf[]"]').on('change', function(e) {
			let $this = $(this);
			let $container = $this.parents('.js-extra-golf-container');
			e.preventDefault();
			let $data = $container.find('.js-extra-golf-total').data();
			if(parseInt($data.luggageQuantity,10) == 0){
				alert(api.literals['QUOTE.FORM.GOLF.SELECT_PLAYERS']);
				$this.prop('checked', '');		
			} else
			{
				let totalPrice = parseFloat($data.luggageTotal);
				$this.data('price', totalPrice);
				$container.find('.js-see-prices').addClass('disabled');
				let golfItem = $data.luggage;
				let $selected = $container.find('.js-extra-golf-selection[data-luggage="' + golfItem + '"]');
				let selectedGolf = {
					id : $(this).data('serviceId'),
					addService : $this.is(':checked'),
					passengers : []
				};
				if($this.is(':checked'))
				{
					$selected.each( function () {
						let $elem = $(this);
						let numPaxes =$elem.data('luggageQuantity');
						let type = $elem.data('type') == 'child' ? 'CHILD' : 'ADULT';
						let age = type == 'CHILD' ? 10 : 30;
						for(let i=1; i<= numPaxes; i++)
						{
							selectedGolf.passengers.push(
								{ 
									type : type,
									age : age
								});
						}	
					});
				} else
				{
					$container.find('.js-see-prices').removeClass('disabled');
				}					
				__updateOptionalService($this, selectedGolf,__toggleFromQuoteSummary);
			}
		});
	}
	
	/**
	 * Actualiza el totalAmount del quote con los servicios opcionales y equipaje seleccionados actualmente
	 */
	function __updateTotalAmount() {
		let result = api.options.totalAmount;
		
		$('.js-toggle-from-quote-summary:checked').each(function() {
			result += parseFloat($(this).data('price')) || 0;
		});
		
		$('.js-change-summary-baggage').each(function() {
			let code = $(this).val();
			result += api.options.baggagePrices[code] || 0;
		});

		$('.js-golf-toggle-from-quote-summary:checked').each(function() {
			result += parseFloat($(this).data('price')) || 0;
		});
		
		$('[data-js-total-amount]').each(function(){
			$(this).data('jsTotalAmount', result);
			$(this).html(__import.utils.format.asCurrency( result ));
		});
		
		$('#penaltiesTable tr:last-child td:last-child')[0].innerText = __import.utils.format.asCurrency( result );
	}
	
	/**
	 * Valida el formulario en el lado de cliente
	 */
	function __validateForm(rq, url, callback) {
		__import.utils.forms.validateRequest(rq, url, callback, __private.$form);
		return false;
	}
	
	/**
	 * Manda la petición al controlador que imprime el documento PDF
	 */
	function __printQuote() {
		let rq = __serializeForm(__private.$form);
		//la vista de netos/brutos se saca del radio no asociado a ningún form
		rq.breakdownView = api.options.breakdown;
		__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().quote.print, true);
	}

	/**
	 * Muestra un modal si el vuelo ha dado un error en el bloqueo por No Disponibilidad
	 */
	function __checkFlightPrebooking() {
		if (api.options.flightNoAvailable) {
			let dialog = { 
				image : '/sltwww/st4/desktop/images/common/sorry3.png', 
				text: api.literals[api.options.dialogLiteralKey], 
				buttons : [ 
					{ 
						label : api.literals['COMMON.GO_BACK'], 
						events : {
							click : function () {
								let rq = api.options.availRq;
								__import.utils.spinner.show();
								__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
							}
						}
					} ] };
			__import.modals.dialog(dialog);
		}
	}

	/**
	 * Muestra un modal si el vuelo ha cambiado de precio
	 */
	function __checkFlightPriceChanged() {
		if (api.options.flightPriceChanged) {
			let dialog = { 
				image : '/sltwww/st4/desktop/images/common/sorry3.png', 
				text: api.literals['QUOTE.WARNING.FLIGHT_PRICE_CHANGED'], 
				buttons : [ 
					{ 
						label : api.literals['COMMON.GO_BACK'], 
						events : {
							click : function () {
								let rq = api.options.availRq;
								__import.utils.spinner.show();
								__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
							}
						}
					}, 
					{ label : api.literals['COMMON.CONTINUE'], dismiss : true } ] };
			__import.modals.dialog(dialog);
		}
	}
	
	/**
	 * Muestra un modal si el hotel está en estado RQ con vuelo de emisión directa
	 */
	function __checkHotelRqWithInmediateIssue() {
		if (api.options.hotelRqWithInmediateIssue) {
			let dialog = { 
				image : '/sltwww/st4/desktop/images/common/sorry3.png', 
				text: api.literals['QUOTE.WARNING.HOTEL_RQ_WITH_INMEDIATE_ISSUE'], 
				buttons : [ 
					{ 
						label : api.literals['COMMON.GO_BACK'], 
						events : {
							click : function () {
								let rq = api.options.availRq;
								__import.utils.spinner.show();
								__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
							}
						}
					}, 
					{ label : api.literals['COMMON.CONTINUE'], dismiss : true } ] };
			__import.modals.dialog(dialog);
		}
	}
	
	/**
	 * Muestra un modal si el hotel está en estado RQ con vuelo de emisión directa a la hora de darle al botón de Reservar
	 */
	function __checkHotelRqWithInmediateIssueAlert() {
		if (api.options.hotelRqWithInmediateIssue) {
			let dialog = { 
				image : '/sltwww/st4/desktop/images/common/sorry3.png', 
				text: api.literals['QUOTE.WARNING.HOTEL_RQ_WITH_INMEDIATE_ISSUE_ALERT'], 
				buttons : [ 
					{ label : api.literals['COMMON.CONTINUE'], dismiss : true } ] };
			__import.modals.dialog(dialog);
		}
	}
	
	
	/**
	 * Inicia el flujo de pago immediato
	 */
	function __startImmediatePayment( rq, params ) {
		//[Julio Martinez][20-06-2018] guarda la rq para utilizarla en el callback __immediatePaymentCallback en caso de exito
		__private.immediatePaymentSubmitRq = rq;
		if ( params ) {
			$.when(
				$.post( __import.webUtils.routes().quote.createExpedient, { rq : JSON.stringify(rq) }) 
			).then(function( response, textStatus, jqXHR ) {
				if (response && response.result && response.result.ok && response.data ) {
					//Asignamos el correo de reserva a la información de tarjeta
					if (rq != null && rq.agency != null && rq.agency.email!=null) {
						params.emailPagando = rq.agency.email;
					}

					params.locataPagando = response.data;
					rq.expedient = response.data;

					//abre la pasarela de conexflow en una ventana nueva
			        $("#payModal").addClass("is-active");
					
			        let rqInside = {
		        		importePagando: params.importePagando,
		                locataPagando: params.locataPagando,
		                emailPagando: params.emailPagando,
		                esPrepago: 'S',
		    			rescod:params.rescod//,
//			    		customerMobilePhoneNumber:,
//			    		billingStreetPrimary:,
//			    		billingCity:,
//			    		billingPostalCode:,
//			    		billingCountry:
		            };

			        let urlPayment = __import.webUtils.routes().quote.immediatePaymentSlt;
			        if (api.options.isComing2) {
			        	urlPayment = __import.webUtils.routes().quote.immediatePaymentCo2;
			        	rqInside.locataPagando = rqInside.locataPagando.substring(3, rqInside.locataPagando.length);
			        }

			        $.ajax({
			        	url: urlPayment,
		                type: "POST",
		                async: false,
		                data: {
		                    rq: JSON.stringify( rqInside )
		                },
		                dataType: 'json',
		                success: function(dataEnvio)
		                {
		                    __import.utils.spinner.hide();
		                    let inputForm = "";
		                    let datosRespuesta = dataEnvio.data;
		                    $.each(datosRespuesta.formElements, function(key, value){
		                        inputForm += "<input type='hidden' name='"+key+"' value='"+value+"'>";
							});
		                	inputForm += "<input type='hidden' name='HPP_POST_DIMENSIONS' value='"+datosRespuesta.formIframeUrl+"'>";
		                    inputForm += "<input type='hidden' name='HPP_LANG' value='"+datosRespuesta.formLang+"'>";
		                    $("#addonForm").append(inputForm);
		                    $("#addonForm").attr("action", datosRespuesta.formUrl);
		                    $("#addonForm").submit();
		                },
		                error: function(){}
		            });
				} else {
					//Si es un error de sesion mostrar el modal de sesión caducada
					if (response && response.result && !response.result.ok && response.result.errorCode == "ERR-003" ) {
						__import.utils.spinner.hide();
						__showSessionTimeoutModalError();
					}
					else
					{
						//Sino seguir con esto
						__import.utils.spinner.hide();
						$('.js-submit-form').prop('disabled', false);
						let errorMessage = response && response.result ? response.result.errorMessage : 'Ocurrió un error al crear el nuevo expediente'; 
						__import.modals.alert(errorMessage);
					}
				}
			});
		}
	}
	
	/**
	 * Muestra un modal si el vuelo ha dado un error en el bloqueo por No Disponibilidad
	 */
	function __showSessionTimeoutModalError() {
			let dialog = { 
				image : '/sltwww/st4/desktop/images/common/sorry3.png', 
				text: api.literals['QUOTE.WARNING.SESSION_TIMEOUT'], 
				buttons : [ 
					{ 
						label : api.literals['COMMON.GO_BACK'], 
						events : {
							click : function () {
								let rq = api.options.availRq;
								__import.utils.spinner.show();
								__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
							}
						}
					} ] };
			__import.modals.dialog(dialog);
	}
	
	function __immediatePaymentCallback( importe, authCode, currencyCode, orderId, timestamp, pasRef, reasonCode, resource, brand, market, result) {
		let rq = __private.immediatePaymentSubmitRq;
		let url = __import.webUtils.routes().book.book;
		
		if (result == "OK" && rq && url) {
			if (__private.immediatePaymentWindow && !__private.immediatePaymentWindow.closed) {
				__private.immediatePaymentWindow.close();
			}
			
			rq.paymentData = {
				importe : importe,
				authCode : authCode,
				currencyCode : currencyCode,
				orderId : orderId,
				timestamp : timestamp,
				pasRef : pasRef,
				reasonCode: reasonCode,
				resource : resource,
				brand: brand,
				market : market
			}
			__import.utils.forms.submitRequestForm( rq, url);
		} else {
			__import.utils.spinner.hide();
			__import.modals.alert("Ocurrió un error al procesar el pago a traves de la pasarela");
		}
	}
	
	function __initLegalModal()
	{
		__private.$form.on('click','.js-modal-legal', function( event ) {
			event.preventDefault();
			__import.utils.legalModal.load(__import.webUtils.routes().legal.load,$(this).data('pagetype'));
		});	
	}
	
	function __initCustomValidations()
	{
		let $email = $('#holderMail')
		  , $repeatEmail = $('#holderRepeatMail');

		if($repeatEmail.length > 0)
		{
			$email.on('keyup keypress blur change', function(){
				__validateEmail();
			});
			$repeatEmail.on('keyup keypress blur change', function(){
				__validateEmail();
			});
		}
		
		function __validateEmail(){
			let $email = $('#holderMail')
				, $repeatEmail = $('#holderRepeatMail');

			if($email.val() != '' && $repeatEmail.val() != '' && $email.val() != $repeatEmail.val()) {
				$repeatEmail[0].setCustomValidity(api.literals['QUOTE.FORM.VALIDATION.EMAILS_DONT_MATCH']);
			} else {
				$repeatEmail[0].setCustomValidity('');
			}
		}
	}
	
	function __initDelayedQuote()
	{
		if(api.options.delayedQuoteActive){
			initSearchingQuote();
			updateQuote();
		}
	}
	
	function initSearchingQuote(){
		$('.js-submit-form').each(function(){
				$(this).prop( "disabled", true );
			});
			
        function blink_text() {
		    $('#titlePrice').fadeOut(500);
		    $('#titlePrice').fadeIn(500);
		    $('#summaryPrice').fadeOut(500);
		    $('#summaryPrice').fadeIn(500);
		}
		priceInterval = setInterval(blink_text, 1000);
		if ($("#insurancesQuoteData").length) {
			$("#insurancesQuoteData").find('.c-checkbox__element').each(function(){
				$(this).prop( "disabled", true );
			});
		}
		if ($("#transferQuoteData").length) {
			$("#transferQuoteData").find('.c-checkbox__element').each(function(){
				$(this).prop( "disabled", true );
			});
		}
		
		$('.js-print-quote').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.js-send-mail').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('#breakdownToggle').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.js-mybp-login').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('#quoteBreakdownBox :input').attr('disabled', true);
		$( ".js-print-quote" ).removeAttr( 'href' );
		$( ".js-send-mail" ).removeAttr( 'href' );
		$( "#breakdownToggle" ).removeAttr( 'href' );
		$( "#breakdownToggle" ).off();
		$('.myBpContainer').each(function(){
			$(this).addClass( 'u-display-none' );
		});
	}
	
	
	function clearSearchingQuote(){
		$('.js-submit-form').each(function(){
				$(this).prop( "disabled", false );
			});
		$('#delayedQuoteWarning').remove();
		clearInterval(priceInterval);
		$('#breakdownToggle').unbind('click');
		$('#quoteBreakdownBox :input').attr('disabled', false);
		$('.myBpContainer').each(function(){
			$(this).removeClass( 'u-display-none' );
		});

	}
		
    function updateQuote(){
        try {
            let rq = {
                budgetId : api.options.quoteRq.budgetId,
                myBpAccount : api.options.quoteRq.myBpAccount,
                availToken : api.options.quoteRq.availToken,
                productType : api.options.quoteRq.productType,
                fromPage : api.options.quoteRq.fromPage,
                forceQuote : true
            };
            fromPage = rq.fromPage;
            $.ajax({
                type : 'post',
                url : __import.webUtils.routes().quote.delayedQuote,
                data : {rq : JSON.stringify(rq)},
                dataType : 'json',
                success : function(response) {
                    if (response && response.result && response.result.ok) {
                        let holderForm = $('#holderForm');
                        let passengersForm = $('#passengersForm');
                        $('#quoteWarningMessages').replaceWith(response.warningMessagesHtml);
                        $('#titleContent').replaceWith(response.titleHtml);
                        $('#breakdownContent').replaceWith(response.breakdownHtml);
                        $('#formContent').replaceWith(response.formHtml);
                        $('#summaryContent').replaceWith(response.summaryHtml);
                        $('#payModal').replaceWith(response.paymentHtml);
                        $('#holderForm').replaceWith(holderForm);
                        $('#passengersForm').replaceWith(passengersForm);
                        clearSearchingQuote();
                        api.options.delayedQuoteActive = false;
                        let jsInit = response.jsInit;
                        if (jsInit) {
                            //Parche al no poder generar el json sin dobles comillas
                            jsInit = jsInit.replace("\"$('.myBpContainer')\"", "$('.myBpContainer')");
                            jsInit = jsInit.replace("\"$('.myBpSummary')\"", "$('.myBpSummary')");
                            eval(jsInit);
                        }
                    }else{
                        let jsInit = response.jsInit;
                        if (jsInit) {
                            //Parche al no poder generar el json sin dobles comillas
                            jsInit = jsInit.replace("\"$('.myBpContainer')\"", "$('.myBpContainer')");
                            jsInit = jsInit.replace("\"$('.myBpSummary')\"", "$('.myBpSummary')");
                            eval(jsInit);
                        }
                        let dialog = {
                            image : '/sltwww/st4/desktop/images/common/sorry3.png',
                            text: api.literals['QUOTE.ERROR.QUOTE_ERROR'],
                            buttons : [
                                {
                                    label : api.literals['COMMON.GO_BACK'],
                                    events : {
                                        click : function () {
                                            let rq = api.options.availRq;
                                            rq.fromPage = fromPage;
                                            __import.utils.spinner.show();
                                            __import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
                                        }
                                    }
                                }] };
                        __import.modals.dialog(dialog);
                    }
                },
                error : function() {
                    let dialog = {
                        image : '/sltwww/st4/desktop/images/common/sorry3.png',
                        text: api.literals['QUOTE.ERROR.QUOTE_ERROR'],
                        buttons : [
                            {
                                label : api.literals['COMMON.GO_BACK'],
                                events : {
                                    click : function () {
                                        let rq = api.options.availRq;
                                        rq.fromPage = fromPage;
                                        __import.utils.spinner.show();
                                        __import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
                                    }
                                }
                            }] };
                    __import.modals.dialog(dialog);
                },
            });

        } catch (e) {
            let dialog = {
                image : '/sltwww/st4/desktop/images/common/sorry3.png',
                text: api.literals['QUOTE.ERROR.QUOTE_ERROR'],
                buttons : [
                    {
                        label : api.literals['COMMON.GO_BACK'],
                        events : {
                            click : function () {
                                let rq = api.options.availRq;
                                rq.fromPage = fromPage;
                                __import.utils.spinner.show();
                                __import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().availability.availability);
                            }
                        }
                    }] };
            __import.modals.dialog(dialog);
        }
    }

    function updateAmounts(element){
        $('#titlePrice').replaceWith($(element).find('#titlePrice'));
        $('#summaryPrice').replaceWith($(element).find('#summaryPrice'));
    }

    function updateMyBp(element){
        $('.myBpSummary').first().replaceWith($(element).find('.myBpSummary').first() );
    }

    function updateById(element, id){
        if ($('#' + id).length) {
            $('#' + id).replaceWith($(element).find('#' + id));
        }
    }
})();
/**
 * FIXME IMPORTANTE
 * [Julio Martinez][20-06-2018] ESTA FUNCION LA LLAMA pago_tarjeta_puce.jsp
 * La ventana de popup de la pasarela de pago busca esta función en su opener (la pantalla de Quote)
 * Aqui debe de estar la logica segun el resultado del pago inmediato
 * @param date
 * @param rescod
 * @param amount
 * @param result
 * @param mac
 * @param originalOperation
 * @param originalAuthorization
 * @returns
 */
function finalPrepago( importe, authCode, currencyCode, orderId, timestamp, pasRef, reasonCode, resource, brand, market, result) {
	com.grupopinero.octopus.packages.quote.Quote.immediatePaymentCallback(
			importe,
			authCode, 
			currencyCode, 
			orderId, 
			timestamp, 
			pasRef, 
			reasonCode,
			resource,
			brand, 
			market,
			result
			);
}