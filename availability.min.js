var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.common = com.grupopinero.octopus.packages.common || {};
com.grupopinero.octopus.packages.common.Utils = (function(){
	'use strict'
	
    var api = {
    		routes: __getRoutes,
	};
    return api;
	
	function __getRoutes() {
		var base = '/package/process/';
		var parentBase = com.grupopinero.common.Globals.options.isLogged 
			? '/b2b/'
			: '/b2c/';
		parentBase += 'slt/';
			
		return {
			home : base + 'home/Home',
			availability : {
				availability : base + 'availability/Availability',
				filter       : base + 'availability/AvailabilityFilter',
				flights      : base + 'availability/AvailabilityFlights',
				changeFlight : base + 'availability/ChangeAvailabilityFlight',
				calendar     : base + 'availability/FlightsCalendar',
				checkAllowedSelling     : base + 'availability/CheckAllowedSelling',
				loadOrigins : base + 'availability/GetDestinationOrigins',
				loadAvailableMonths : base + 'availability/GetAvailableMonths',
				trace : base + 'availability/Trace',
				delayed : base + 'availability/AvailabilityDelayed'
			},
			hotel : base + 'hotel/HotelDetails',
			quote : {
				quote 				: base + 'quote/Quote',
				print 				: base + 'quote/Print',
				send  				: base + 'quote/Send',
				createExpedient 	: base + 'quote/CreateExpedient',
				immediatePaymentSlt : '/b2b/slt/pagos/PagoReservaAddonHpp',
				immediatePaymentCo2	: '/coming2/reservas/pagos/PagoReservaAddonHpp',
				updateOptionalService : base + 'quote/UpdateOptionalService',
				delayedQuote : base + 'quote/DelayedQuote'
			},
			book : {
				book  		 : base + 'book/Book',
				saveBudget	 : base + 'book/SaveBudget',
				print 		 : base + 'book/Print',
				send  		 : base + 'book/Send',
				excursionsCrossSelling : '/excursion/process/availability/Availability'
			},
			caches : {
				caches : base + '/caches/CacheManager',
				refresh : base + '/caches/CacheRefresh'
			},
			legal : {
				load : parentBase + 'legal/LegalAjax',
			}
		};
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.common = com.grupopinero.octopus.packages.common || {};
com.grupopinero.octopus.packages.common.Accomodation = (function(){
	'use strict'

	var __private = {
		    DEFAULT_AGE: 30,
		    MAX_PAX: 9 
	};

	var api = {
		initAccomodation : __initAccomodation,
		literals : {}
	};
	
	return api;
	
	function __initAccomodation($form,params, maxRooms, literals) {
		__activeRooms($form);
		__initAccomodationListeners($form);
		__initAccomodationParams($form,	params, maxRooms);
	}
	
	function __initAccomodationListeners($form) {
		$form.find('.js-add-room').on('click', function() {
			__addRoom($form );
		});
		
		$form.find('.c-booking__room-delete').on('click', function() {
			__removeRoom($form, $(this).data('index') );
			__removeAllPassengers($form, $(this).data('index') );
		});
		
		$form.find('.js-controls-more').on('click',function() {
			__addPassengerAge($form, $(this).data('index') );
		});
		
		$form.find('.js-controls-less').on('click',function() {
			__removePassengerAge($form, $(this).data('index') );
		});

		$form.find('.js-accomodation-room-passengers').on('change' ,function() {
			var $currentRoom = $(this).parents('.js-room');
			var roomIndex = $currentRoom.data('index');
			var value = parseInt($(this).val());
			if (_.isNaN(value)) {
				value = 3;
				$(this).val(value);
			}
			__setRoomPassengers($form, roomIndex, value );
		});
	}
	
	function __activeRooms( $form )
	{
		let $activeRooms = $form.find('.o-layout.c-booking__room-row:not(.u-display-none)');
		var i = 0;
		for(i = 0; i < $activeRooms.length; i++)
		{
			if($form.find('input.js-room[data-index="' + i + '"]').val() <= 1)
			{
				$form.find('.js-controls-less[data-index="' + i + '"]').first().addClass('is-disabled');
			}
			else if($form.find('input.js-room[data-index="' + i + '"]').val() >= 8 || __countActivePax($form)>=__private.MAX_PAX)
			{
				__disableMore($form, i);
			}
		}
	}
	
	function __addRoom( $form )
	{
		console.debug('addRoom');
		let $hiddenRooms = $form.find('.o-layout.c-booking__room-row.u-display-none');
		if($hiddenRooms.length > 0 && __countActivePax($form)<__private.MAX_PAX)
		{
			let $firstRoom = $hiddenRooms.first();
			$firstRoom.removeClass('u-display-none');
			$firstRoom.find('input.js-room').prop('disabled','');
			$firstRoom.find('input.js-room').removeAttr('style');
			if(__countActivePax($form) == __private.MAX_PAX-1){
				$firstRoom.find('input.js-room').val('1');
			}else{
				$firstRoom.find('input.js-room').val('2');
			}
			var roomIndex = $firstRoom.data('roomIndex') - 1;
			let $lessDisabled = $form.find('.js-controls-less.is-disabled[data-index="' + roomIndex + '"]');
			let $moreDisabled = $form.find('.js-controls-more.is-disabled[data-index="' + roomIndex + '"]');
			if($lessDisabled.length > 0)
			{
				$lessDisabled.first().removeClass('is-disabled');
			}
			if($moreDisabled.length > 0 && __countActivePax($form) < __private.MAX_PAX-1)
			{
				$moreDisabled.first().removeClass('is-disabled');
			}
			 if(__countActivePax($form) == __private.MAX_PAX-1){
				 __firstTwoPassengers($form, $firstRoom.data('roomIndex') );
				 __disableMore($form, roomIndex);
				let $toDisabled = $form.find('.js-controls-less[data-index="' + roomIndex + '"]');
				$toDisabled.first().addClass('is-disabled');
			 }else{
				__firstTwoPassengers($form, $firstRoom.data('roomIndex') );
				__firstTwoPassengers($form, $firstRoom.data('roomIndex') );
			 }
			__updateAccomodationLabel($form);
		}
	}
	
	function __removeRoom( $form, roomIndex )
	{
		console.debug('removeRoom');
		let $roomToRemove = $form.find('.o-layout.c-booking__room-row[data-room-index="' + roomIndex + '"]');
		if($roomToRemove.length > 0)
		{
			$roomToRemove.addClass('u-display-none');
			$roomToRemove.find('input.js-room').prop('disabled','disabled');
			__updateAccomodationLabel($form);
		}
	}
	
	function __updateAccomodationLabel($form)
	{
		let placeHolder ='';
		let visibleRooms = 	$form.find('.o-layout.c-booking__room-row:not(.u-display-none)').length;
		let visiblePassengers = $form.find('.c-ages__item.c-input-square:not(.u-display-none)').length;
		placeHolder= placeHolder + visibleRooms + ' '  + (visibleRooms > 1 ? 'Habitaciones' : 'Habitación');	
		placeHolder=  placeHolder + ', ' + visiblePassengers + ' '  + (visiblePassengers > 1 ? 'Pasajeros' : 'Pasajero');	
		$form.find('input[name="passengers"]').attr('placeHolder', placeHolder);
	}
	
	function __addPassengerAge( $form, roomIndex )
	{
		console.debug('addPassengerAge');
		let $hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
		let $lessDisabled = $form.find('.js-controls-less.is-disabled[data-index="' + roomIndex + '"]');
		if($hiddenAges.length > 0 && __countActivePax($form)<__private.MAX_PAX)
		{
			$hiddenAges.first().removeClass('u-display-none');
			$hiddenAges.first().find('input.js-age').prop('disabled','');
			if($lessDisabled.length > 0)
			{
				$lessDisabled.first().removeClass('is-disabled');
			}
			$hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
			if($hiddenAges.length <= 0 || __countActivePax($form) == __private.MAX_PAX)
			{
				__disableMore($form, 3);				
			}
			__updateAccomodationLabel($form);
		}
	}
	
	function __firstTwoPassengers( $form, roomIndex )
	{
		console.debug('firstTwoPassengers');
		roomIndex = roomIndex - 1;
		let $hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
		if($hiddenAges.length > 0)
		{
			$hiddenAges.first().removeClass('u-display-none');
			$hiddenAges.first().find('input.js-age').prop('disabled','');
		}
	}
	
	function __removePassengerAge( $form, roomIndex )
	{
		console.debug('removePassengerAge');
		let $hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
		let $lessDisabled = $form.find('.js-controls-less[data-index="' + roomIndex + '"]');
		let $moreDisabled = $form.find('.js-controls-more.is-disabled[data-index="' + roomIndex + '"]');
		var index = 0;
		if($hiddenAges.length > 0)
		{
			index = $hiddenAges.first().data("passenger-index") - 1;
		}
		else
		{
			index = 8;
		}
		if(index > 1)
		{
			let $ageToRemove = $form.find('.c-ages__item.c-input-square[data-room-index="' + roomIndex + '"][data-passenger-index="' + index + '"]');			
			if($ageToRemove.length > 0)	
			{
				$ageToRemove.addClass('u-display-none');
				$ageToRemove.find('input.js-age').prop('disabled','disabled');
				if($moreDisabled.length > 0)
				{
					__enableMore($form, index);
				}
				$hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
				if($hiddenAges.length >= 7)
				{
					$lessDisabled.first().addClass('is-disabled');				
				}
			}
		}
		__updateAccomodationLabel($form);
	}
	
	function __removeAllPassengers( $form, roomIndex )
	{
		console.debug('removeAllPassengers');
		roomIndex = roomIndex - 1;
		var index = 0;
		let $hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
		let $allAges = $form.find('.c-ages__item.c-input-square[data-room-index="' + roomIndex + '"]');
		let $ageToRemove = $form.find('.c-ages__item.c-input-square[data-room-index="' + roomIndex + '"][data-passenger-index="' + index + '"]');
		if( $hiddenAges.length <= 0 )
		{
			$ageToRemove = $form.find('.c-ages__item.c-input-square[data-room-index="' + roomIndex + '"][data-passenger-index="8"]');
			$ageToRemove.addClass('u-display-none');
			$ageToRemove.find('input.js-age').prop('disabled','disabled');
			$hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
		}	
		while( $hiddenAges.length < $allAges.length )
		{
			index = $hiddenAges.first().data("passenger-index") - 1;
			$ageToRemove = $form.find('.c-ages__item.c-input-square[data-room-index="' + roomIndex + '"][data-passenger-index="' + index + '"]');
			$ageToRemove.addClass('u-display-none');
			$ageToRemove.find('input.js-age').prop('disabled','disabled');
			$hiddenAges = $form.find('.c-ages__item.c-input-square.u-display-none[data-room-index="' + roomIndex + '"]');
		}
		__enableMore($form, roomIndex);
		roomIndex = roomIndex + 1;
		__removeRoom($form, roomIndex);
		__updateAccomodationLabel($form);
	}
	
	function __initAccomodationParams($form, params, maxRooms) {
		var rooms = _.get(params, 'accomodation.rooms.length', 1);
		_.times(maxRooms, function(index) {
			var passengers = _.get(params, 'accomodation.rooms['+index+']passengers.length', index ? 0 : 2);
			__setRoomPassengers( $form, index, passengers );
			__setPassengersAges( $form, index, _.get(com.grupopinero.octopus.packages.common.SearchForm.options.params, 'accomodation.rooms['+index+']passengers'));
		});
		__setRooms($form, rooms);
		//Se enseña el contenedor de habitaciones. Para evitar el efecto raro que 
		//hace cuando pinta todas las habitaciones y luego las esconde
		var $target = $form.find('input[name="target"]');
		if($target.length > 0 && $target.val() == 'SUBHOME' )
		{
			$('.js-rooms').addClass('is-active');
		}
	}

	function __setRooms( $form, newRoomCount ) {
		/* set rooms */
		var currentRoomCount = $form.find('.js-room:not(.js-room-hidden)').length;
		var $rooms = $form.find('.js-room');
		var i;
		if (newRoomCount < currentRoomCount) {
			var $roomsToHide = $rooms.slice(newRoomCount, currentRoomCount);			
			$roomsToHide.addClass('js-room-hidden');
			$roomsToHide.hide();
			var $passengersToHide = $roomsToHide.find('.js-passenger-age');
			$passengersToHide.addClass('js-passenger-age-hidden');
			$passengersToHide.find('input').attr('disabled','disabled');
		} else if (newRoomCount > currentRoomCount) {
			var $roomsToShow = $rooms.slice(currentRoomCount, newRoomCount);
			$roomsToShow.removeClass('js-room-hidden');
			$roomsToShow.show();
			for (i = currentRoomCount; i < newRoomCount; i++) {
				var $roomToShow = $($rooms.get(i));
				var currentPassengers = $roomToShow.find('.js-accomodation-room-passengers:checked').val() || $roomToShow.find('select.js-accomodation-room-passengers').val(); 
				__setRoomPassengers($form, i, currentPassengers );
			}
		}
	}
	
	function __setRoomPassengers($form, roomIndex, newPassengerCount) {
		var $currentRoom = $($form.find('.js-room').get( roomIndex ));
		var currentPassengerCount = $currentRoom.find('.js-passenger-age:not(.js-passenger-age-hidden)').length;
		var $passengers = $currentRoom.find('.js-passenger-age');
		if (newPassengerCount < currentPassengerCount) {
			var $passengersToHide = $passengers.slice(newPassengerCount, currentPassengerCount);
			$passengersToHide.addClass('js-passenger-age-hidden');
			$passengersToHide.find('input').attr('disabled','disabled');
			$passengersToHide.hide();
		} else if (newPassengerCount > currentPassengerCount) {
			var $passengersToShow = $passengers.slice(currentPassengerCount, newPassengerCount);
			$passengersToShow.removeClass('js-passenger-age-hidden');
			$passengersToShow.find('input').removeAttr('disabled');
			$passengersToShow.show();
		}
	}
	
	function __setPassengersAges($form, roomIndex, passengers)
	{
		var $currentRoom = $($form.find('.js-room').get( roomIndex ));
		var $passengers = $currentRoom.find('.js-passenger-age');
		var passengersAges = [];
		
		if(passengers)
		{
			passengersAges =_(passengers).map(function(passenger) {
				return passenger.age;
			}).value();
		} else
		{
			passengersAges =_.times($passengers.length, _.constant(__private.DEFAULT_AGE));
		}
		_.forEach($passengers, function(passenger, key) {
			var passengerAge = passengersAges[key] ? passengersAges[key] : __private.DEFAULT_AGE;
			$(passenger).find('input').val(passengerAge);
		});
	}
	
	function __countActivePax($form){
		let $passengerAges =  $form.find('.c-ages__item.c-input-square:not(.u-display-none)');
		return $passengerAges.length;
	}
	
	function __disableMore($form, index){
		let i = 0;
		let $toDisable;
		for(i = 0; i<=index; i++){
			$toDisable = $form.find('.js-controls-more[data-index="' + i + '"]').first();
			$toDisable.addClass('is-disabled');
		}
	}
	
	function __enableMore($form, index){
		let i = 0;
		let $toEnable;
		for(i = 0; i<=index; i++){
			$toEnable = $form.find('.js-controls-more[data-index="' + i + '"]').first();
			$toEnable.removeClass('is-disabled');
		}
	}
	
	function __removeRoom($form, index){
		let $roomToRemove = $form.find('.o-layout.c-booking__room-row[data-room-index="' + index + '"]');
		$roomToRemove.addClass('u-display-none');
		$roomToRemove.find('input.js-room').prop('disabled', 'disabled');
	}

})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.common = com.grupopinero.octopus.packages.common || {};
com.grupopinero.octopus.packages.common.SearchForm = (function(){
	'use strict'
	
	var __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils,
		modals: com.grupopinero.octopus.helper.common.Modals,
		accomodation : com.grupopinero.octopus.packages.common.Accomodation
	};
	
	var __private = {
	    DISPLAY_DATE_FORMAT: 'L',
	    LONG_DATE_FORMAT : 'LL',
	    DATE_FORMAT: 'YYYY-MM-DD',
		$form : undefined,
		$originCode : undefined,
		$destinationCode : undefined,
		$destinationName : undefined,
		$startMonth : undefined,
		$startDate : undefined,
		$submit : undefined,
		calendar : undefined
	};
	
	var api = {
		options : {
			maxRooms : 4,
			residentData : {},
			calendarStartMonth : moment().startOf('month').format(__private.DATE_FORMAT),
			calendarEndMonth : undefined,
			language : 'es'
		},
		literals : {},
		init : __init,	
		initDestinations : __initDestinations
	};
	
	return api;
	
	function __init(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);
		
		__initFields();
		
		// inicializa el submit del form
		__initFormSubmit();

		// Inicializa el comportamiento del selector de destino
		__initSetDestination();
		
		// comportamiento al cambiar el origen
		__initChangeOrigin();
		
		// Inicializa el componente de cambio de habitaciones
		__import.accomodation.initAccomodation(__private.$form, api.options.params, api.options.maxRooms,api.literals);

		// Inicializa el calendario
		__initCalendar();
		
		// Inicializa el tipo de residente
		__initResidentType();
		
        __loadParams();
        
        __initTrace();
	}
	
	function __initTrace()
	{
		$(document.body).on('click','.js-trace', function(){
			var $this = $(this);
			var rq = $this.data();
//			__import.utils.spinner.show();
			
			$.when( $.post( __import.webUtils.routes().availability.trace, 
				{ rq: JSON.stringify( rq ) })
			)
			.then(function( response ) {
				if (response && response.result && response.result.ok ) {
					var dataTree = response.data.children;
					$('#tree1').tree({
				        data: dataTree,
				        autoOpen: 3,
				        onCreateLi: function(node, $li) {
				        	if( node.url != null ) {
				        		var a = $li.find('span')[0];
				        		a.outerHTML = '<a style="text-decoration:none" href="' + node.url + '" target="_blank">' + a.outerHTML + '</a>';
				        	};
				        	if( node.color ) {
				        		var nodeToColor = $li.find('span')[0];
				        		nodeToColor.style.color = node.color;
				            };
				        }
				    });
//					__import.utils.spinner.hide();	
					$this.removeClass('js-trace');
				} else {
//					__import.utils.spinner.hide();
				}
			});
		});
	}
	
	function __initFields()
	{
		var $form = $('form[data-package-form]');
		__private.$form = $form;
		__private.$originCode = $form.find('[name="originCode"]');
		__private.$originName = $form.find('[name="originName"]');
		__private.$destinationCode = $form.find('[name="destinationCode"]');
		__private.$destinationName = $form.find('[name="destinationName"]');
		__private.$startMonth = $form.find('[name="startMonth"]');
		__private.$startDate = $form.find('[name="startDate"]');
		__private.$numNights = $form.find('[name="numNights"]');
		__private.$submit = $form.find('[type=submit]');
	
		moment.locale(api.options.language);
    	if(api.options.language == 'pt')
    	{
            flatpickr.localize(pt.Portuguese);
    	} else if(api.options.language == 'es'){
    		flatpickr.localize(es.Spanish);
    	} else {
            flatpickr.localize(es.default);
    	}
    	
    	let numNightsSelector = __getChoiceElement(__private.$form,__private.$numNights);
    	if($(numNightsSelector.element.value) != '')
    	{
    		$(numNightsSelector.containerOuter).addClass('selected');
    	}
	}
	
	function __initDestinations(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);

		// Inicializa el comportamiento del selector de destino */
		__initSetDestination();
		// Inicializa el tipo de residente */
		__initResidentType();
	}
	
	/**
	 * 
	 * @private
	 */
    function __loadParams() {
        var params = api.options.params;
        
        if (!!params.originCode && !!params.destinationCode && !!params.startDate && params.submitEnabled) {
			__unblockSubmit();
        }
    }
    
    /**
	 * Change return date picker disabled state
	 */
    function __blockSubmit() {
    	__private.$submit.prop('disabled', true);
    }

    /**
	 * Change return date picker disabled state
	 */
    function __unblockSubmit() {
    	__private.$submit.prop('disabled', false);
    }
    
	/**
	 * inicializa el submit del form
	 */
	function __initFormSubmit() {
		if(api.options.params.startDate && api.options.params.onlyOneDayCalendar) 
		{
			__private.$form.find('.js-search').prop('disabled', false);
		}

		__private.$form.on('submit', function( event ) {
			try {
				event.preventDefault();
				var rq = __serializeForm( );
				__import.utils.loading.show({ subtitle : __getLoadingSubtitle( rq ), title : __getLoadingDescription( rq )} );
				__import.utils.forms.submitRequestForm( rq, __private.$form.attr('action' ));
			} catch (exception) {
				console.error(exception.message);
				__import.utils.loading.hide();
			}
			return false;
		});
	}
	
	/**
	 * Devuelve la etiqueta del subtitulo para la pantalla de carga de disponibilidad
	 */
	function __getLoadingSubtitle( rq ) {
		if (rq) {
			var originName = __private.$originName.val();
			if (originName) {
			   return __import.utils.literals.replaceParams(api.literals['COMMON.SEARCHFORM.BREADCRUMBS.ROUTE'], originName, rq.destinationName);
			} else {
			  return __import.utils.literals.replaceParams(api.literals['COMMON.SEARCHFORM.BREADCRUMBS.ROUTE_SH'], rq.destinationName);
			}
		}
	}
	
	/**
	 * Devuelve la etiqueta de descripcion para la pantalla de carga de disponibilidad
	 */
	function __getLoadingDescription( rq ) {
		if (rq) {
			var startDate =  moment( rq.startDate, __private.DATE_FORMAT).format(__private.DISPLAY_DATE_FORMAT)
			var endDate =  moment( rq.startDate, __private.DATE_FORMAT).add( rq.numNights, 'days' ).format(__private.DISPLAY_DATE_FORMAT)
			var numNights = rq.numNights > 1
				? __import.utils.literals.replaceParams(api.literals['COMMON.NIGHTS'], rq.numNights)
				: api.literals['COMMON.NIGHT'];
			var rooms = rq.accomodation.rooms.length > 1
				? __import.utils.literals.replaceParams(api.literals['COMMON.ROOMS'], rq.accomodation.rooms.length)
				: api.literals['COMMON.ROOM'];
			var passengerCount = _.sumBy(rq.accomodation.rooms, function(room) { return room.passengers.length });
			var passengers = passengerCount > 1
				? __import.utils.literals.replaceParams(api.literals['COMMON.PASSENGERS'], passengerCount)
				: api.literals['COMMON.PASSENGER'];
			return __import.utils.literals.replaceParams(
					api.literals['COMMON.SEARCHFORM.LOADING.DESCRIPTION'], 
					startDate,
					endDate,
					numNights,
					passengers,
					rooms );
		}
	}
	
	function __initChangeOrigin() {
		console.debug('__initChangeOrigin');
		if (api.options.params.productType != 'HOTEL_PRODUCT') {
			__getChoiceElement(__private.$form,__private.$originCode).passedElement.addEventListener('choice', function(event) {
				var originValueTemp = event.detail.choice.value;
				var originCode = originValueTemp.split('####')[0];
				var destinationCode = __private.$destinationCode.val();
				__clearStartDate();
				__private.$originName.val(event.detail.choice.label.replace('(' + originCode + ')','').trim());
				__checkResidentType(originCode, destinationCode.split('*')[0]);
				
				//update Lista Meses
				if( api.options.calendarEndMonth == undefined ) {
					__updateAvailableMonths(destinationCode, originCode);					
				}
			}, false);
		}
	}
	
	function __initSetDestination() {
		__private.$form.on( 'click', '.js-set-destination', function() {
			var destinationCode = $(this).data('code');
			__setDestination(this, destinationCode, $(this).data('description'));
			if (api.options.params.productType != 'HOTEL_PRODUCT') {
				var originCode = __private.$originCode.val();
				__checkResidentType(originCode, destinationCode.split('*')[0]);
				__loadOrigins(destinationCode);
			}
		});
	}
	
	function __loadOrigins(destinationCode)
	{
		let rq = {
				destinationCode : destinationCode.split('*')[0]
		};
		
		let originSelector = __getChoiceElement(__private.$form,__private.$originCode);
		__clearChoices(originSelector);
		
		console.debug('RQ: ', rq);
		__import.utils.spinner.show();
		try {
			$.ajax({
				type : 'post',
				url : __import.webUtils.routes().availability.loadOrigins,
				data : { rq: JSON.stringify(rq)},
				dataType : 'json',
				success : function(response) {
					// Se oculta el spinner
					if (response && response.result && response.result.ok) {
						console.debug('Data', response.data);
						let defaultAirportAvailable= false;
						jQuery.each(response.data.origins, function(i, val) {
							//Comprobamos si el aeropuerto por defecto esta en la lista de origenes
							defaultAirportAvailable  = defaultAirportAvailable | (val.code == response.data.defaultAirport);
							originSelector.setChoices([ {
								value : val.code,
								label : val.description + ' (' + val.code + ')',
								selected : val.code == response.data.defaultAirport
							}],'value', 'label', false );
						});
						
						//Si el aeropuerto por defecto esta en la lista de origenes
						//actualizamos los meses
						if(defaultAirportAvailable)
						{
							__updateAvailableMonths(destinationCode, response.data.defaultAirport);
							originSelector = __getChoiceElement(__private.$form,__private.$originCode);
				    		$(originSelector.containerOuter).addClass('selected');
				    		if(response.data.defaultAirport == "MAD")
			    			{
				    			__private.$originName.val("Madrid");
				    			__checkResidentType("MAD", destinationCode.split('*')[0]);
			    			}
				    		else if(response.data.defaultAirport == "LIS")
			    			{
				    			__private.$originName.val("Lisboa");
				    			__checkResidentType("LIS", destinationCode.split('*')[0]);
			    			}
						}
					} else {
						__import.utils.notifications.toast( response ? response.result.errorMessage : 'Response is null' );
					}
					__import.utils.spinner.hide();
				},
				error : function(response) {
					__import.utils.notifications.toast( 'Error');
					console.error('An error occurred: ', response);
					// Se oculta el spinner
					__import.utils.spinner.hide();
				},
			});
		} catch (e) {
			console.error(e.message);
			__import.utils.spinner.hide();
		}
	}
	
	function __clearChoices(select) {
		select.destroy();
		select.init();
		select._clearChoices();
	}

	function __updateAvailableMonths(destinationCode, originCode )
	{
		console.debug('__updateAvailableMonths');
		let rq = {
				destinationCode : destinationCode.split('*')[0],
				originCode : originCode,
				idLanding : api.options.params.idLanding,
				idLanConf : api.options.params.idLandingConf,
				familyCode : api.options.params.codeFamily,
				productCode : api.options.params.codeProduct
		}

		console.debug('RQ: ', rq);
		__import.utils.spinner.show();
		
		let monthSelector = __getChoiceElement(__private.$form,__private.$startMonth);
		console.debug('Clear month selector');
		__clearChoices(monthSelector);

		try {
			$.ajax({
				type : 'post',
				url : __import.webUtils.routes().availability.loadAvailableMonths,
				data : { rq: JSON.stringify(rq)},
				dataType : 'json',
				success : function(response) {
					// Se oculta el spinner
					if (response && response.result && response.result.ok) {
						console.debug('Fill Month Selector', response.data);
						jQuery.each(response.data.availableMonths, function(i, val) {
							monthSelector.setChoices([ {
								value : val.strDate,
								label : val.label,
								disabled: !val.active,
							}],'value', 'label', false);
						});
					} else {
						__import.utils.notifications.toast( response ? response.result.errorMessage : 'Response is null' );
					}
					__import.utils.spinner.hide();
				},
				error : function(response) {
					__import.utils.notifications.toast( 'Error');
					console.error('An error occurred: ', response);
					// Se oculta el spinner
					__import.utils.spinner.hide();
				},
			});
		} catch (e) {
			console.error(e.message);
			__import.utils.spinner.hide();
		}
	}
	
	function __checkResidentType( originCode, destinationCode ) {
		var $form = __private.$form;
		var residentData = api.options.residentData;
		var $wrapper = $form.find('.js-resident-type-wrapper');
		var $checkbox = $form.find('[name=residentType]');
	
		if (originCode && destinationCode && residentData && residentData[originCode] && residentData[originCode][destinationCode]) {
			var value = residentData[originCode][destinationCode];
			var label = api.literals['COMMON.SEARCHFORM.RESIDENT_DISCOUNT'];
			$checkbox.removeAttr('disabled');
			$form.find('.js-resident-type-label').html(label);
			$checkbox.val(value);
			$wrapper.removeClass('u-display-none');
		} else {
			$checkbox.prop('disabled','disabled');
			$checkbox.removeAttr('value');
			$wrapper.addClass('u-display-none');
		}
	}
	
	function __setDestination( element, code, name ) {
		__private.$destinationName.val( name );
		__private.$destinationCode.val(code);
		var $container = $(element).parents('[data-popover-box]');
		$container.removeClass('is-active');
		$container.find('.c-list-basic__link.is-active').removeClass('is-active');
		__clearStartDate();
	}
	
	function __clearStartDate() {		
		__private.$form.find('.js-start-month-container').removeClass('u-display-none');
		var choiceElement = __getChoiceElement(__private.$form, __private.$startMonth);
		choiceElement.enable();
		choiceElement.setValueByChoice('null');
		__private.$form.find('.js-start-date-container').addClass('u-display-none');
		__private.$startDate.prop('disabled','disabled');
		__private.$startDate.val(undefined);
		__blockSubmit();
	}
	
	function __getElementKey($form, $field)
	{
		return $form.attr('name') + '_' + $field.attr('name');	
	}
	
	function __getChoiceElement($form, $field)
	{
		return window.selects[__getElementKey($form, $field)];
	}
	
	function __serializeForm(  ) {
		var rq = __private.$form.serializeJSON({
			useIntKeysAsArrayIndex : true,
			parseNumbers : true
		});
		
		//quita elementos que no se necesitan para la peticion
		delete rq.roomCount;
		
		rq.accomodation.rooms = _(rq.accomodation.rooms).map(function(room) {
			delete room.passengerCount;
			return room;
		}).filter( function (room) {
			return Object.keys(room).length;
		}).value();
		
		//convierte las fechas al formato correcto
		if (rq.startDate) {
			rq.startDate = moment( rq.startDate, __private.DISPLAY_DATE_FORMAT ).format(__private.DATE_FORMAT);
		}
		
		rq.onlyHotel = rq.originCode ? "N" : "S";

		rq.productType = rq.onlyHotel == "S" ? "HOTEL_PRODUCT" : "PACKAGE";
		
		if(api.options.params.productType != 'HOTEL_PRODUCT') {    
			var originValueTemp = rq.originCode;                    
			rq.originCode = originValueTemp.split('####')[0];        
		}
		
		return rq;
	}
	
	function __initCalendar() {
		__initCalendarWidget(__getCalendarOptions());
		__initCalendarEvents();
	}
	
	function __initCalendarEvents() {
		__private.$form.on('change', '.js-open-calendar', function() {
			__loadCalendar( $(this).val() );
		});
		__private.$form.on('click', 'input.js-open-calendar', function() {
			__loadCalendar( $(this).val() );
		});
		
		var $container = __private.$form.parent().find('[data-calendar-box]');
		
		console.debug('Container: ', $container.length);
		
		$container.on('click', '[data-day]', function() {
			__selectCalendarDay( $(this).data('day') );
			__checkDefaultNights($(this).data('nights'), $(this).data('day') );
		});
		
		$container.on('click', '[data-calendar-nav]', function() {
			__navigateCalendar( $(this).data('calendarNav') );
		});
		
		$container.on('click', '[data-month]', function() {
			__loadCalendar( $(this).data('month') );
		})
	}
	
	function __navigateCalendar(nav) {
		var currentDate = moment(__private.calendar.options.day, __private.DATE_FORMAT).startOf('month');
		var newDate;
		switch (nav) {
		case 'prev':
			newDate = currentDate.subtract( 1, 'months');
			break;
		case 'next':
			newDate = currentDate.add( 1, 'months');
			break;
		default:
			break;
		}
		if (__isInCalendarRange(newDate)) {
			__loadCalendar(newDate.format(__private.DISPLAY_DATE_FORMAT));
		}
	}
	
	function __selectCalendarDay(calendarDay) {
		if (calendarDay) {
			var day = moment(calendarDay, __private.FORMAT_DATE).format(__private.DISPLAY_DATE_FORMAT)
			__private.$startMonth.prop('disabled','disabled');
			__private.$form.find('.js-start-month-container').addClass('u-display-none');
			__private.$form.find('.js-start-date-container').removeClass('u-display-none');
			__private.$form.find('.js-start-date-container').addClass('selected');
			__private.$startDate.removeAttr('disabled').val(day);
			$('[data-calendar-container]').removeClass('is-active');
            $('header').removeClass('js-toback');
			__showPassengerSelection();
		}
	}
	
    function __showPassengerSelection()
    {
		$('.js-rooms').addClass('is-active');
		__unblockSubmit();
    }
    
	function __loadCalendar(day) {
		if (day && day != 'null') {
			var calendarDay = moment( day , __private.DISPLAY_DATE_FORMAT ).format(__private.DATE_FORMAT); 
			__import.utils.spinner.show(); 
			// Parece que tenemos que esperar algo de tiempo antes de invocar el calendario, 
			// si no es así, no siempre muestra la capa de loading.
			setTimeout(___loadCalendar, 400);
		}

		function ___loadCalendar() {	
			let url = __getFlightsCalendar({
	            startDate : calendarDay
	        });
	        try {
				$.ajax({
					type : 'get',
					url : url,
					dataType : 'json',
					success : function(response) {
						if (response) {
							console.debug('Data', response);
							
							__private.calendar.setOptions({
								day : calendarDay,
								events_source : response.result
							});
							$('[data-calendar-container]').addClass('is-active');
							$('.js-calendar-months').html(__getCalendarMonths(calendarDay));
							$('span.calendar-origin').html(__private.$originName.val());
							$('span.calendar-destination').html(__private.$destinationName.val());
							__private.calendar.view();
							//Actualizamos la leyenda...
							if(response.legendHtml)
							{
								$('.js-calendar-legend').html(response.legendHtml);
							}
	        				console.log('aptBaselongDistanceDestination: ', response.aptBaselongDistanceDestination);
	        				console.log('longDistanceDestination: ', response.longDistanceDestination);			
						}
						__import.utils.spinner.hide();
					},
					error : function(response) {
						__import.utils.notifications.toast( 'Error');
						console.error('An error occurred: ', response);
						// Se oculta el spinner
						//__import.utils.spinner.hide();
					},
				});
			} catch (e) {
				console.error(e.message);
				__import.utils.spinner.hide();
			}
		}
	}
	
	function __initCalendarWidget(options) {
		__private.calendar = window.app._calendar(undefined, options, function(){});
	}
	
	function __getCalendarOptions() {
		var language;
		switch($('html').attr('lang')) {
		case 'PT':
			language = 'pt-PT';
			break;
		case 'EN':
			language = 'en-BR';
			break;
		case 'ES':
		default:
			language = 'es-ES';
			break;
		}
		
		return {
            display_week_numbers: false,
            weekbox: false,
            language : language,
    		tmpl_path: '/sltwww/st4/desktop/tmpls/',
            day: api.options.params.startDate || 'now',
            onBeforeEventsLoad : function(next) {
            	next();
            },
            onAfterViewLoad: function(view) {
    			$('[data-calendar-current-month]').text(this.getTitle());
    			__import.utils.spinner.hide();
    			if($('[data-calendar]').is(':visible'))
    			{
    				$('header').addClass('js-toback');
    			} else
    			{
    				$('header').removeClass('js-toback');
    			}
    		},
    		events_source: []
    	};
	}
	
	function __getFlightsCalendar(override) {
		var rq = $.extend(true, __serializeForm( ), override);
		rq.numNights = undefined;
		//[Julio Martinez][03-08-2018] es necesario pasar el utcOffset para asegurarse de que el WS genera timestamps correctos
		rq.utcOffset = moment().utcOffset();
		return __import.webUtils.routes().availability.calendar + '?rq=' + encodeURIComponent( JSON.stringify( rq ) );
	}
	
	/**
	 * Pinta la barra de meses del calendario con la fecha actual con la que se pidió el calendario
	 */
	function __getCalendarMonths(day){
		if (day) {
			var currentDate = moment( day , __private.DATE_FORMAT).startOf('month');
			var result = _.map(_.range(-5,7), function(offset){
				var monthDate =  currentDate.clone().add( offset, 'months' ) ;
				var nodeClass = 'c-calendar__month' + (!offset ? ' is-active' : '');
				var attributes = {
					'class' : nodeClass	
				}
				if ( __isInCalendarRange(monthDate) ) {
					attributes['data-month'] = monthDate.format(__private.DISPLAY_DATE_FORMAT); 
				}
				return $('<div/>', attributes)
					.html( monthDate.format('MMM').toUpperCase().replace(/\W/g, '') );
			});
			return result;
		}
	}
	
	function __initResidentType(){
		var originCode = __private.$originCode.val();
		var destinationCode = (__private.$destinationCode.val() || '').split('*')[0];
		__checkResidentType(originCode, destinationCode);
	}
	
	/**
	 * Comprueba si una fecha de moment.js se encuentra entre los limites del calendario
	 */
	function __isInCalendarRange( date ) {
		var startMonth = moment( api.options.calendarStartMonth, __private.DATE_FORMAT).startOf('month');
		var endMonth = api.options.calendarEndMonth ? moment( api.options.calendarEndMonth, __private.DATE_FORMAT) : undefined;
		
		return date && !date.isBefore(startMonth) && (!endMonth || !date.isAfter(endMonth));
	}
	
	
	/**
	 * Comprueba si el numero de dias inicial es inferior a 7 ( cantidad inicial por defecto), 
	 * si es así, muestra un modal informando al cliente sobre los precios en base a la cantidad de días
	 */
	function __checkDefaultNights(numNights, day) {
		if (!isNaN(parseInt(numNights)) && !Object.is(numNights, 7)) {
			
			var choiceElement = __getChoiceElement(__private.$form, __private.$numNights);
			//[Julio Martinez][20-05-2019] El numero de noches debe pasarse como string a Choices.js, porque es como funciona la funcion setValueByChoice
			// ATENCION: En la documentacion de Choices.js, la funcion ha pasado a llamarse setChoiceByValue en versiones posteriores
			choiceElement.setValueByChoice(numNights.toString());
			__import.utils.spinner.hide();
			//mostrar modal de informacion de numero de noches
			__defaultNightsChangedModal(numNights, day);
		}
	}
	/**
	 * Modal de informacion para el cliente, los precios del calendario no son en base a 7 dias 
	 */
	function __defaultNightsChangedModal(numNights, day) {
		var button = {
	        	   label: api.literals['COMMON.CONTINUE'],
	        	   type: 'secondary u-mrh-xs',
	        	   classes: '',
	        	   dismiss: true,
	        	   events: undefined
				}

		var dialog = { 
			text: __import.utils.literals.replaceParams(api.literals['COMMON.SEARCHFORM.CALENDAR.DEFAULT_NIGHTS_CHANGED'], numNights), 
			image : '', 
			classes : 'u-pd-l',
			buttonContainerClass : 'u-flex-right',
			buttons : [
					button
				]
			};
		__import.modals.dialog(dialog);
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.common = com.grupopinero.octopus.packages.common || {};
com.grupopinero.octopus.packages.common.Filters = (function(){
	'use strict'
	
	var __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils
	};
	
	var api = {
		options : {
			params : undefined,
			$form : undefined,
			$formConnection : undefined,
			paginationEventSelector: undefined,
			paginationConnectionEventSelector: undefined,
			sortEventSelector: undefined,
			submitUrl : undefined,
			callback : undefined,
			callbackConnection : undefined
		},
		init : __init,
		submitForm : __submitForm
	};
	
	return api;
	
	function __init(options) {
		api.options = $.extend(true, api.options, options);
		
		__initPagination();
		__initSort();
		__initFiltering();
		
		__initConnectionPagination();
		__initConnectionFiltering();
	}
	
	function __initPagination(){
		if ( api.options.paginationEventSelector ) {
			$(document.body).on( 'click', api.options.paginationEventSelector, function(event) {
				var page = $(this).data('page');
				if (page) {
					__changePage( page );
				}
				event.stopImmediatePropagation();
			});
		}
	}
	
	function __initConnectionPagination(){
		if ( api.options.paginationConnectionEventSelector ) {
			$(document.body).on( 'click', api.options.paginationConnectionEventSelector, function(event) {
				var page = $(this).data('page');
				if (page) {
					__changeConnectionPage( page );
				}
				event.stopImmediatePropagation();
			});
		}
	}
	
	function __initSort() {
		if ( api.options.sortEventSelector ) {
			$(document.body).on( 'click', api.options.sortEventSelector, function() {
				var type = $(this).data('orderType');
				var direction = $(this).data('orderDirection');
				if (type && direction) {
					__changeOrder( type, direction );
				}
			});
		}
	}
	
	function __changePage( page ) {
		if (api.options.params) {
			var rq = api.options.params;
			rq.pageNumber = page;
			
			__submitForm( rq );
		}
	}
	
	function __changeOrder( type, direction ) {
		if (api.options.params) {
			var rq = api.options.params;
			rq.orderType = type;
			rq.orderDirection = direction;
			rq.pageNumber = 1;
			
			__submitForm( rq );
		}
	}
	
	function __changeConnectionPage( page ) {
		if (api.options.params) {
			var rq = api.options.params;
			rq.pageNumber = page;
			
			__submitConnectionForm( rq );
		}
	}
	
	function __changeConnectionOrder( type, direction ) {
		if (api.options.params) {
			var rq = api.options.params;
			rq.orderType = type;
			rq.orderDirection = direction;
			rq.pageNumber = 1;
			
			__submitConnectionForm( rq );
		}
	}
	
	function __initFiltering() {
		__initFilterCheckboxes();
		__initFilterSubmit();
	}
	
	function __initConnectionFiltering() {
		__initFilterConnectionCheckboxes();
		__initFilterConnectionSubmit();
	}
	
	function __initFilterSubmit() {
		$(api.options.$form).on( 'change', ':input' , function() {
		   $(this).trigger('submit');
		});
		$(api.options.$form).submit( function(event) {
			try {
				event.preventDefault();
				
				var filters = $(this).serializeJSON({
					useIntKeysAsArrayIndex : true,
					parseNumbers : true
				});
				filters.selectedHotelsCodes = filters.selectedHotelsCodes.split(';');
				filters.pageNumber = 1;
				api.options.params = $.extend(false, api.options.params, filters);
				__submitForm( api.options.params );
				
			} catch (e) {
				console.error('Error inicializando filtros: ', e.message);
			}
			return false;
		});
	}
	
	function __initFilterConnectionSubmit() {
		$(api.options.$formConnection).on( 'change', ':input' , function() {
		   $(this).trigger('submit');
		});
		$(api.options.$formConnection).submit( function(event) {
			try {
				event.preventDefault();
				
				var filters = $(this).serializeJSON({
					useIntKeysAsArrayIndex : true,
					parseNumbers : true
				});
				filters.selectedHotelsCodes = filters.selectedHotelsCodes.split(';');
				filters.pageNumber = 1;
				api.options.params = $.extend(false, api.options.params, filters);
				__submitConnectionForm( api.options.params );
				
			} catch (e) {
				console.error('Error inicializando filtros: ', e.message);
			}
			return false;
		});
	}
	
	function __initFilterCheckboxes(){
		$(api.options.$form).on( 'change', '.js-filter-checkbox-all', function() {
			__updateCheckboxAll($(this));
		});
		$(api.options.$form).on( 'change', '.js-filter-checkbox', function( event ) {
			var name = $(this).attr('name').replace('[]','\\[\\]');
			var $form = $(this).closest('form');
			var $checkboxAll = $form.find('.js-filter-checkbox-all[name='+name+']');
			//activa el checkboxAll si no hay ningun otro checkbox activo
			$checkboxAll.prop('checked', !$form.find('.js-filter-checkbox[name='+name+']:checked').length );
			__updateCheckboxAll($checkboxAll);
		});
		$(api.options.$form).find('.js-filter-checkbox-all').prop('checked', true).each(function() {
			__updateCheckboxAll($(this))
		});
	}
	
	function __initFilterConnectionCheckboxes(){
		$(api.options.$formConnection).on( 'change', '.js-filter-checkbox-all', function() {
			__updateCheckboxAll($(this));
		});
		$(api.options.$formConnection).on( 'change', '.js-filter-checkbox', function( event ) {
			var name = $(this).attr('name').replace('[]','\\[\\]');
			var $formConnection = $(this).closest('form');
			var $checkboxAll = $formConnection.find('.js-filter-checkbox-all[name='+name+']');
			//activa el checkboxAll si no hay ningun otro checkbox activo
			$checkboxAll.prop('checked', !$formConnection.find('.js-filter-checkbox[name='+name+']:checked').length );
			__updateCheckboxAll($checkboxAll);
		});
		$(api.options.$formConnection).find('.js-filter-checkbox-all').prop('checked', true).each(function() {
			__updateCheckboxAll($(this))
		});
	}
	
	function __updateCheckboxAll($checkboxAll) {
		var name = $checkboxAll.attr('name').replace('[]','\\[\\]');
		var $form = $checkboxAll.closest('form');
		var $hidden = $form.find('.js-filter-checkbox-all-hidden[name='+name+']');
		if ($checkboxAll.is(':checked')) {
			$checkboxAll.attr('disabled', true);
			//guarda el valor en un hidden mientras este deshabilitado
			if (!$hidden.length) {
				$checkboxAll.after($('<input/>', {
					type: 'hidden',
					name : $checkboxAll.attr('name'),
					'class' : 'js-filter-checkbox-all-hidden',
					value : $checkboxAll.val()
				}));
			}
			//desactiva el resto de checkboxes
			$form.find('.js-filter-checkbox[name='+name+']:checked').prop('checked',false);
		} else {
			$checkboxAll.removeAttr('disabled');
			$hidden.remove();
		}
	}
	
	function __submitForm( rq ) {
		var url = api.options.submitUrl || $form.attr('action');
		if(!rq.forceAvail){
			__import.utils.spinner.show();
		}
		$.post( url, 
			{ rq: JSON.stringify( rq ) }, 
			function( response ) {
				__import.utils.spinner.hide();
				api.options.callback( response, rq )
				var state = new URLSearchParams(window.location.search).get('state');
				if(state==null){
					window.history.replaceState("", "", "/package/process/availability/Availability?availToken=" + response.availToken + "&state=1");
				}
				else{
					state = +state+1;
					window.history.replaceState("", "", "/package/process/availability/Availability?availToken=" + response.availToken + "&state=" + state);
				}	
			}, 
			'json' );
	}
	
	function __submitConnectionForm( rq ) {
		var url = api.options.submitUrl || $form.attr('action');
		__import.utils.spinner.show();
		$.post( url, 
			{ rq: JSON.stringify( rq ) }, 
			function( response ) {
				__import.utils.spinner.hide();
				api.options.callbackConnection( response )
				var state = new URLSearchParams(window.location.search).get('state');
				if(state==null){
					window.history.replaceState("", "", "/package/process/availability/Availability?availToken=" + response.availToken + "&state=1");
				}
				else{
					state = +state+1;
					window.history.replaceState("", "", "/package/process/availability/Availability?availToken=" + response.availToken + "&state=" + state);
				}	
			}, 
			'json' );
	}
});
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.availability = com.grupopinero.octopus.packages.availability || {};
com.grupopinero.octopus.packages.availability.Flights = (function(){
	'use strict'
	
	var __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils
	};
	
	var api = {
		options : {},
		literals : {},
		init : __init,
		selectAllFlightTypes : __selectAllFlightTypes
	}
	
	var __private = { 
		FLIGHT_TYPE_SELECTORS : {
			RECOMMENDED : ".js-recommended-flight",
			CHEAPEST : ".js-cheapest-flight"
		},
		previousTab : null,
		connectionsTab : null
	}
	
	return api;
	
	function __init(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);
		__initImports();
		__initFlightSelector();
		__initMoreFlights();
		__initChangeFlight();
		__initTabs();
	}
	
	function __initImports() {
		$(document).ready(function(){
			__import.flightFilters = com.grupopinero.octopus.packages.availability.FlightFilters;
			__import.delayedAvail = com.grupopinero.octopus.packages.availability.DelayedAvailability;
		});
	}
	
	function __initFlightSelector() {
		__selectAllFlightTypes( api.options.flightType || 'RECOMMENDED' );
		
		$(document.body).on('click', '[data-toggle-flight]', function() {
			var data = $(this).data();
			__selectFlightType( data.toggleFlight, data.source, data.target );
		});
	}
	
	function __selectAllFlightTypes( flightType ) {
		__selectFlightType( flightType, '.js-flights-container-special', '.js-load-more-flights-result-special' );
		__selectFlightType( flightType, '.js-flights-container', '.js-load-more-flights-result' );
		__selectFlightType( flightType, '.js-flights-container-special', '.js-load-connections-flights-result-special' );
		__selectFlightType( flightType, '.js-flights-container', '.js-load-connections-flights-result' );
	}
	
	/**
	 * Inicio de la busqueda por AJAX de vuelos alternativos
	 */
	function __initMoreFlights() {
		if (api.options.othersParams || api.options.specialParams) {
			$.notify( api.literals['AVAILABILITY.FLIGHTS.LOADING'], {
			  //[Julio Martinez][22-06-2018] Este className en realidad incluye dos clases para poder encontrar el toast y ocultarlo
			  //Es un hack pero notifyJs no me devuelve la instancia del toast que he creado
			  className: 'info js-loading-more-flights',
			  autoHide: false,
			  clickToHide: false
			});
			
			var otherHotelsRq = api.options.othersParams ? $.post( __import.webUtils.routes().availability.flights, 
				{ rq: JSON.stringify( api.options.othersParams ) }
			) : null;
			
			var bahiaPrincipeHotelsRq = api.options.specialParams ? $.post( __import.webUtils.routes().availability.flights, 
				{ rq: JSON.stringify( api.options.specialParams ) }
			) : null;
			
			$.when(otherHotelsRq, bahiaPrincipeHotelsRq).done(__loadMoreFlightsResult);
			
			$('.js-go-to-more-flights').click(function(){
				var data = $(this).data();
				__changeTabsVisibility( 'content-flights', data.hideHotelTab );
				__goToMoreFlights( $(this).data('moreFlightsContainer') );
			});
		}
	}
	
	function __clearLoadingToast() {
		//[Julio Martinez][22-06-2018] NotifyJs no me devuelve la instancia del toast.
		$('.js-loading-more-flights').closest('.notifyjs-wrapper').trigger('notify-hide');
	}
	
	function __changeTabsVisibility( tab, previousTab ) {
		if (tab) {
			$('button[data-tab-click='+tab+']').removeClass('u-display-none');
		}
		if (previousTab) {
			$(__private.connectionsTab).addClass('u-display-none');
			$('button[data-tab-click='+previousTab+']').addClass('u-display-none');
			__private.previousTab = previousTab;
		} else {
			$(__private.connectionsTab).removeClass('u-display-none');
			$('button[data-tab-click='+ __private.previousTab +']').removeClass('u-display-none');
		}
	}
	
	function __goToMoreFlights( moreFlightsContainer ) {
		if (moreFlightsContainer) {
			$('.js-load-more-flights-content > *').addClass('u-display-none');
			$('.js-load-more-flights-content').find(moreFlightsContainer).removeClass('u-display-none');
		}
		
		$('.js-more-flights-button').removeClass('u-display-none').trigger('click');
	}
	
	function __setSelectedFlight(source, target) {
		var currentFlightClass = 'js-current-flight-' + api.options.flightType;
			
		var $currentFlight = $(source).find( '.' + currentFlightClass ).clone().removeClass( currentFlightClass );
		var currentFlightPrice = parseFloat($(source).find('.js-current-flight-price-' + api.options.flightType ).val());
		
		var $target = target ? $(target) : $(document);
		
		var numPaxesWithoutInfants = $target.find('.js-flight-numPaxesWithoutInfants').val();
		$target.find('.js-flight-total-amount').each(function() {
			var priceDifference = (parseFloat($(this).val()) - currentFlightPrice) / numPaxesWithoutInfants;
			$(this).siblings('.js-flight-total-amount-difference').html( (priceDifference < 0 ? '-' : '+') + Math.abs(priceDifference).toFixed(0) );
		});
		$target.find('.js-change-flight-selected-flight').html( $currentFlight );
	}
	
	function __selectFlightType(flight, source, target) {
		if (flight) {
			api.options.flightType = flight.toUpperCase();
		}

		var selector = __private.FLIGHT_TYPE_SELECTORS[api.options.flightType];
		if (selector) {
			var hideSelector = _(__private.FLIGHT_TYPE_SELECTORS)
				.values()
				.filter(function(s) { return s != selector })
				.join(', ');
			
			$(hideSelector).addClass('u-display-none');
			$(selector).removeClass('u-display-none');
			$(selector).filter('.c-price__from').addClass('u-flex u-flex-bottom u-flex-right');
			$(hideSelector).removeClass('u-flex u-flex-bottom u-flex-right');
		}
		
		__setSelectedFlight(source, target);
	}
	
	function __loadMoreFlightsResult( otherHotelsresponse, specialHotelsResponse ) {
		__clearLoadingToast();
		
		var othersResult = __processLoadMoreFlightsResponse( otherHotelsresponse ? otherHotelsresponse[0] : null, {
			container : '.js-load-more-flights-result',
			connectionsContainer : '.js-load-connections-flights-result',
			count : '.js-load-more-flights-count',
			countBase : '.js-load-base-flights-count',
			priceDifference : '.js-load-more-flights-priceDifference',
			visible : '.js-load-more-flights-count-wrapper'
		});
		
		var specialResult = __processLoadMoreFlightsResponse( specialHotelsResponse ? specialHotelsResponse[0] : null, {
			container : '.js-load-more-flights-result-special',
			connectionsContainer : '.js-load-connections-flights-result-special',
			count : '.js-load-more-flights-count-special',
			countBase : '.js-load-base-flights-count-special',
			priceDifference : '.js-load-more-flights-priceDifference',
			visible : '.js-load-more-flights-count-wrapper-special'
		});
		
		if (othersResult.ok || specialResult.ok ) {
//			if (!(othersResult.count && specialResult.count)) {
//				//[Julio Martinez Rodenas][06-11-2018] se debe mostrar la pestaña de cambiar vuelo
//				//solo en los casos que no tengamos dos dispos separadas de vuelos
//				$('.js-more-flights-button').removeClass('u-display-none');
//			}
			
			//[Julio Martinez Rodenas][06-11-2018] Será visible el filtro de Bahia Principe si se pudo cargar
			var visibleResultSelector = specialResult.count ? '.js-load-more-flights-result-special' : '.js-load-more-flights-result';
			$(visibleResultSelector).removeClass('u-display-none');
			var visibleConnectionsResultSelector = specialResult.count ? '.js-load-connections-flights-result-special' : '.js-load-connections-flights-result';
			$(visibleConnectionsResultSelector).removeClass('u-display-none');
			
			$(__private.connectionsTab).removeClass('u-display-none');

			$( '.js-more-flights-button, .js-go-to-more-flights' ).removeAttr('disabled');
			
			__selectAllFlightTypes();
			
			__import.flightFilters.init({ 
				specialParams : api.options.specialParams,
				othersParams : api.options.othersParams
			});
			//[Gabriel Alonso Perez][03/06/2020] El import se utiliza para cargar los Sliders de los filtros de Vuelo
			window.app.inputRange();
			if (api.options.tab == 'flights') {
				var hideHotelTab;
				var moreFlightsContainer;
				var result;
				if (api.options.previousTab == 'hotels-special') {
					hideHotelTab = 'content-other-hotels';
					moreFlightsContainer = '.js-load-more-flights-result-special';
					result = specialResult;
				} else {
					hideHotelTab = 'content-special-hotels';
					moreFlightsContainer = '.js-load-more-flights-result';
					result = othersResult;
				}
				
				if (result.count) {
					__changeTabsVisibility( 'content-flights', hideHotelTab );
					__goToMoreFlights( moreFlightsContainer );
				} else {
					//[Julio Martinez][12-11-2018] Este es un caso raro con las siguientes condiciones:
					//- una pestaña de hoteles tiene alternativas y la otra no
					//- venimos desde la formalización habiendo pulsado en 'cambiar vuelo'
					$('.js-more-flights-button').addClass('u-display-none');
				}
			} else {
				__simulateTabClick( api.options.tab || (api.options.specialHotelsTabEnabled ? 'hotels-special' : 'hotels') );
			}
		}
		//Sino hay disponibilidad que no muestre error que no hay alternativas porque ni se ha intentado
		/* else {
			var errorMessage = api.literals['AVAILABILITY.FLIGHTS.MORE_FLIGHTS_ERROR'];
			__import.utils.notifications.toast( errorMessage );
		}*/
	}
	
	function __processLoadMoreFlightsResponse(response, selectors) {
		var result = {
			ok 		: false,
			count 	: undefined
		};
		if (selectors && response && response.result && response.result.ok && response.data ) {
			var count = parseInt(response.data.flightsFound);
			if (count) {
				$( selectors.container ).html( response.data.htmlBase );
				$( selectors.connectionsContainer ).html( response.data.html );
				$( selectors.count ).html( response.data.flightsFound );
				$( selectors.countBase ).html( response.data.flightsAlternativesFound );
				if (response.data.flightsAlternativesFound >= 1) {
//					$( selectors.visible ).removeClass( 'u-display-none' );
					$('.js-more-flights-button').removeClass('u-display-none');
				}
			}
			var countConnections = parseInt(response.data.flightsConnectionFound);
			if (countConnections) {
				__private.connectionsTab = '.js-more-connections-button';
				$( selectors.priceDifference ).html( response.data.priceDifference );
			}
			if( response.data.showWarning == 'true' ) {
				$('.js-connections-messages').removeClass('u-display-none');
			}
			result = {
				ok : true,
				count : count
			};
		}
		return result;
	}
	
	function __initChangeFlight(){
		$(document.body).on('click','.js-change-flight', function() {
			var data = $(this).data();
			if (data) {
				//[Julio Martinez][12-11-2018] Si los vuelos recomendados de ambas pestañas son el mismo,
				//se debe cambiar el vuelo en las dos pestañas a la vez
				data.changeBothFlights = !!api.options.sameRecommendedFlights;
				var others = com.grupopinero.octopus.packages.availability.HotelFilters.options.othersParams;
				data.orderType = others.orderType;
				data.orderDirection = others.orderDirection;
				data.idLanding = others.idLanding;
				data.idLandingConf = others.idLandingConf;
				data.pageNumber = $('#hotelPageSelected').data().page;
				data.catalogueHotelCodes = others.catalogueHotelCodes;
				data.catalogueHotels = others.catalogueHotels;
				data.hotelTotalCount = others.hotelTotalCount;
				data.hotelTotalCountInFilter = others.hotelTotalCountInFilter;
				__import.utils.spinner.show();
				__import.utils.forms.submitRequestForm( data, 
					__import.webUtils.routes().availability.changeFlight
				);
			}
		});
	}
	
	function __initTabs() {
		$(document.body).on('click','.js-hide-flights-tab', function() {
			//restaura las posibles pestañas ocultas
			__changeTabsVisibility();
//			$('.js-more-flights-button').addClass('u-display-none');
		});
		
		//[Julio Martinez][08-11-2018] Este es el caso en el que se viene de quote para un budget de Bahia Principe
		__simulateTabClick(api.options.tab);
	}
	
	function __simulateTabClick(tab) {
		switch (tab) {
		case 'hotels':
			$('button[data-tab-click=content-other-hotels]').trigger('click');
			break;
		case 'hotels-special':
			$('button[data-tab-click=content-special-hotels]').trigger('click');
			break;
		}
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.availability = com.grupopinero.octopus.packages.availability || {};
com.grupopinero.octopus.packages.availability.Hotels = (function(){
	'use strict'
	
	var __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils,
		modals: com.grupopinero.octopus.helper.common.Modals,
		flights : com.grupopinero.octopus.packages.availability.Flights
	};
	
	var api = {
		options : {},
		init : __init
	}
	
	var __private = {
	}
	
	return api;
	
	function __init(options) {
		api.options = $.extend(true, api.options, options);
		
		$(document.body).on('click','.js-go-to-hotel-details', function(){
			var rq = $(this).data();
			rq.flightType = __import.flights.options.flightType;
			__import.utils.spinner.show();
			__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().hotel);
		});
		
		$(document.body).on('click','.js-quote-budget', function(){
			var $this = $(this);
			__import.utils.spinner.show();
			$.when( $.post( __import.webUtils.routes().availability.checkAllowedSelling, null) )
			.then(function( response, textStatus, jqXHR ) {
				if (response && response.result && response.result.ok ) {		
					var rq = $this.data();
					__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().quote.quote);
				} else {
					__import.utils.spinner.hide();
					__showNotAllowedSellingDialog(response.result.errorMessage);
				}
			});
		});
		
		$(document.body).on('click','.js-show-hotels', function(){
			__switchHotelTab($(this));
		});
	}
	
	function __showNotAllowedSellingDialog(errorText)
	{
		var dialog = { 
			text: errorText, 
			buttons : [ 
			{ 
					label : 'OK', 
					dismiss : true 
			}]
		};
		__import.modals.dialog(dialog);
	}
	
	function __switchHotelTab($button)
	{
		var tabData = $button.data('tab-button');
		var $tab = $button.closest('[data-tab-container]').find('[data-tab-click="' + tabData + '"]');
		$tab.trigger('click');
	}
	
})();

com.grupopinero.octopus.packages.availability.Hotels.init();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.availability = com.grupopinero.octopus.packages.availability || {};
com.grupopinero.octopus.packages.availability.HotelFilters = (function(){
	'use strict'
	
	var __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils,
		filters : {
			others : com.grupopinero.octopus.packages.common.Filters(),
			special : com.grupopinero.octopus.packages.common.Filters()
		},
		flights : com.grupopinero.octopus.packages.availability.Flights,
		delayedAvail : com.grupopinero.octopus.packages.availability.DelayedAvailability
	};
	
	var api = {
		options : {},
		init : __init
	};
	
	let priceInterval;
	
	return api;
	
	function __init(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);
		
		//Init hoteles generales
		__import.filters.others.init({
			params : api.options.othersParams,
			$form : $(document.forms.hotelFiltersForm),
			submitUrl : __import.webUtils.routes().availability.filter,
			callback : __getCallbackFunction('.js-octopus-availability-results'),
			paginationEventSelector : '.js-change-hotels-page',
			sortEventSelector : '.js-change-order'
		});
		
		//Init pestaña hoteles especiales
		if (api.options.specialParams) {
			__import.filters.special.init({
				params : api.options.specialParams,
				$form : $(document.forms.hotelFiltersFormSpecial),
				submitUrl : __import.webUtils.routes().availability.filter,
				callback : __getCallbackFunction('.js-octopus-availability-results-special'),
				paginationEventSelector : '.js-change-hotels-page-special',
				sortEventSelector : '.js-change-order-special'
			});
		}
		
		$('.inputFilterChecked').each(function(){
			$(this).prop('checked', true);
			var name = $(this).attr('name').replace('[]','\\[\\]');
			var $formConnection = $(this).closest('form');
			var $checkboxAll = $formConnection.find('.js-filter-checkbox-all[name='+name+']');
			$checkboxAll.prop('checked', false)
			$checkboxAll.attr('disabled', false);
		})
	}
	
	//[Julio Martinez][05-11-2018] Este metodo genera una funcion de callback parametrizada 
	//para reemplazar el resultado de la petición AJAX en el contenedor correcto
	function __getCallbackFunction(resultSelector) {
	
		return function(response, rq) {
			
			if (response && response.result && response.result.ok && response.filtersHtml && $.trim(response.filtersHtml)) {
				$(resultSelector).replaceWith( response.filtersHtml );
				__import.utils.app.init(resultSelector);
				com.grupopinero.googletagmanager.GoogleTagManagerEvents.init({ $trackedElements : $(resultSelector).find('[data-gtm]') });
				rq.catalogueHotelCodes = response.catalogueHotelCodes;
				rq.catalogueHotels = response.catalogueHotels;
				rq.hotelTotalCount = response.hotelTotalCount;
				rq.hotelTotalCountInFilter = response.hotelTotalCountInFilter;
				//hay que volver a seleccionar el vuelo que toca
				var flightType = __import.flights.options.flightType || 'CHEAPEST'
				__import.flights.selectAllFlightTypes( flightType ); 
				if(response.executeDelayedFilter){
					if(resultSelector == '.js-octopus-availability-results'){
						if(api.options.othersParams.delayedAvailabilityActive && !api.options.othersParams.forceAvail){
							api.options.othersParams = rq;
							rq.forceAvail = true;
							initSearchingAvail();
							__import.filters.others.submitForm(rq);
						}else{
							api.options.othersParams.forceAvail = false;
							clearPrice();
							__clearLoadingToast();
						}
					}else{
						if(api.options.specialParams.delayedAvailabilityActive && !api.options.specialParams.forceAvail){
							api.options.specialParams = rq;
							rq.forceAvail = true;
							initSearchingAvail();
							__import.filters.special.submitForm(rq);
						}else{
							api.options.specialParams.forceAvail = false;
							clearPrice();
							__clearLoadingToast();
						}
					}
				}
			} else {
				var errorMessage = "No se han encontrado resultados";
				if (response) {
					rq.catalogueHotelCodes = response.catalogueHotelCodes;
					rq.catalogueHotels = response.catalogueHotels;
					rq.hotelTotalCount = response.hotelTotalCount;
					rq.hotelTotalCountInFilter = response.hotelTotalCountInFilter;
					if(response.executeDelayedFilter){
						api.options.othersParams.forceAvail = false;
						clearPrice();
						__clearLoadingToast();
					}
				}
				if (response && response.result && response.result.errorMessage) {
					errorMessage = response.result.errorMessage;
				}
				$(resultSelector).empty();
				__import.utils.notifications.toast( errorMessage );
			}
		}
	
	}
	
	function initSearchingAvail()
	{
		$('.js-quote-budget').attr("disabled", true);
		$('.js-recommended-flight').removeClass('u-display-none');
		$('.js-cheapest-flight').addClass('u-display-none');
		$('#filtersContent :input').attr("disabled", true);
		$('.c-info__icon').off('click');
		$('.c-checkbox :input').attr("disabled", true);
		$('.js-more-flights-button').attr("disabled", true);
		$('.js-more-connections-button').attr("disabled", true);
		$('.js-change-order').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.js-go-to-hotel-details').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.c-hotels-filters__grid-item').each(function(){
			$(this).prop('disabled',true);
		});
		$('.js-change-hotels-page').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('#hotelFiltersForm_hotelCodes').prop('disabled', true);
		
		$('.c-recommended').each(function(){
			$(this).addClass( 'u-display-none' );
		});
		
		$('.c-pagination__link').each(function(){
			$(this).css('cursor', 'not-allowed');
		});
//		$('.c-price__total').each(function(){
//			$(this).remove();
//		});
//		$('.c-price__from').each(function(){
//			$(this).remove();
//		});

		$.notify.defaults({
			position: 'top center',
			style : 'bootstrap',
			className: 'error'
		});
		
		$.notify( api.literals['AVAILABILITY.FORM.LOADING'], {
		  className: 'none js-loading-prices',
		  autoHide: false,
		  clickToHide: false
		});
		
		function blink_text() {
			$('.js-loading-prices').each(function(){
				$(this).removeClass( 'u-display-none' );
				$(this).fadeOut(1000);
				$(this).fadeIn(1000);
			});
		}
		priceInterval = setInterval(blink_text, 1000);
	}
	
	function clearPrice(){
		clearInterval(priceInterval);
		$('.loadingPrices').each(function(){
			$(this).addClass( 'u-display-none' );
		});
		$('.c-calendar__content .c-checkbox :input').attr("disabled", false);
		$('.js-more-flights-button').attr("disabled", false);
		$('.js-more-connections-button').attr("disabled", false);
		$('#filtersContent :input').attr("disabled", false);
		$('#flightFiltersContent :input').attr("disabled", false);
		$('.c-hotels-filters__grid').each(function(){
			$(this).find('input:checkbox:first:checked').attr("disabled", true);
		});
		$('.c-check-list').each(function(){
			$(this).find('input:checkbox:first:checked').attr("disabled", true);
		});
		$('#hotelFiltersForm_hotelCodes').prop('disabled', false);
		$('.c-hotels-filters__grid-item').each(function(){
			$(this).prop('disabled',false);
		});
		$('.c-pagination__link').each(function(){
			$(this).css('cursor', 'pointer');
		});
		$('.unavailable_hotel').each(function(){
			$(this).removeClass( 'u-display-none' );
		});
		$('.hasNoPrice').each(function(){
			$(this).css('opacity', '0.7');
		});
	}
	
	function __clearLoadingToast() {
		$('.js-loading-prices').closest('.notifyjs-wrapper').trigger('notify-hide');
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.availability = com.grupopinero.octopus.packages.availability || {};
com.grupopinero.octopus.packages.availability.FlightFilters = (function(){
	'use strict'
	
	var __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils,
		filters : {
			special : com.grupopinero.octopus.packages.common.Filters(),
			others : com.grupopinero.octopus.packages.common.Filters()
		},
		flights : com.grupopinero.octopus.packages.availability.Flights
	};
	
	var api = {
		options : {},
		init : __init
	};
	
	return api;
	
	function __init(options) {
		api.options = $.extend(true, api.options, options);
		
		//Init Filtros bahia principe
		if (api.options.specialParams) {
			api.options.specialParams.resultsOnly = true;
			__import.filters.special.init({
				params : api.options.specialParams,
				$form : $(document.forms.flightFiltersFormSpecial),
				$formConnection : $(document.forms.flightFiltersConnectionFormSpecial),
				submitUrl : __import.webUtils.routes().availability.flights,
				callback : __getCallbackFunction( '.js-flights-page-results-special' ),
				callbackConnection : __getCallbackConnectionFunction( '.js-connections-flights-page-results-special' ),
				paginationEventSelector : '.js-change-flights-page-special',
				paginationConnectionEventSelector : '.js-connections-change-flights-page-special'
			});
		}
		
		//Init filtros resto de hoteles
		if (api.options.othersParams) {
			api.options.othersParams.resultsOnly = true;
			__import.filters.others.init({
				params : api.options.othersParams,
				$form : $(document.forms.flightFiltersForm),
				$formConnection : $(document.forms.flightFiltersConnectionForm),
				submitUrl : __import.webUtils.routes().availability.flights,
				callback : __getCallbackFunction( '.js-flights-page-results' ),
				callbackConnection : __getCallbackConnectionFunction( '.js-connections-flights-page-results' ),
				paginationEventSelector : '.js-change-flights-page',
				paginationConnectionEventSelector : '.js-connections-change-flights-page'
			});
		}
	}
	
	
	
	//[Julio Martinez][05-11-2018] Este metodo genera una funcion de callback parametrizada 
	//para reemplazar el resultado de la petición AJAX en el contenedor correcto
	function __getCallbackFunction(resultSelector) {
		return function(response) {
			if (response && response.result && response.result.ok && response.data) {
				$( resultSelector ).replaceWith( response.data.htmlBase );
				__import.utils.app.init(resultSelector);
				//hay que volver a seleccionar el vuelo que toca 
				__import.flights.selectAllFlightTypes(); 
			} else {
				var errorMessage = "No se han encontrado resultados";
				if (response && response.result && response.result.errorMessage) {
					errorMessage = response.result.errorMessage;
				}
				$( resultSelector ).empty();
				__import.utils.notifications.toast( errorMessage );
			}
		}
	}
	
	//[Julio Martinez][05-11-2018] Este metodo genera una funcion de callback parametrizada 
	//para reemplazar el resultado de la petición AJAX en el contenedor correcto
	function __getCallbackConnectionFunction(resultSelector) {
		return function(response) {
			if (response && response.result && response.result.ok && response.data) {
				$( resultSelector ).replaceWith( response.data.html );
				__import.utils.app.init(resultSelector);
				//hay que volver a seleccionar el vuelo que toca 
				__import.flights.selectAllFlightTypes(); 
			} else {
				var errorMessage = "No se han encontrado resultados";
				if (response && response.result && response.result.errorMessage) {
					errorMessage = response.result.errorMessage;
				}
				$( resultSelector ).empty();
				__import.utils.notifications.toast( errorMessage );
			}
		}
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.availability = com.grupopinero.octopus.packages.availability || {};
com.grupopinero.octopus.packages.availability.Map = (function(){
	'use strict'
	var api = {
		options : {
			mapId : 'packageAvailabilityMap',
			infoWindowTemplateSelector : '#lodash-template-map-info-window',
			infoWindow : undefined,
			markerTooltipSelector : '#packageAvailabilityMapTooltip',
			markerTooltip : undefined,
			generateIconCache : {},
			markers : [],
			hotelGoogleMapsMarkers : [],
			zones: [],
			mapZones: [],
			mapZonePolygon: undefined,
			zoneGoogleMapsMarkers : [],
			lineZoneWeight : 2,
		    colorZonePoly : "#2063C6",
		    colorZoneMarkerStroke : "#2063C6",
		    colorZoneMarkerFill : "#2063C6"
		},
		init : __init
	}
	return api;

	function __init(options) {
		api.options = $.extend(true, api.options, options);
		__initZones(api.options.zones);
		__initMap(api.options.mapZones);
		__initListeners();
	}

	function __centerControl(controlDiv) {

		// Set CSS for the control border.
	    var controlUI = document.createElement('div');
	    controlUI.id = "goZoneUI";
	    controlUI.title = 'Muestra la visualización por zonas';
	    controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginTop = '10px';
        controlUI.style.textAlign = 'center';

	    controlDiv.appendChild(controlUI);

	    // Set CSS for the control interior.
	    var controlText = document.createElement('div');
	    controlText.id = "goZoneText";
	    controlText.innerHTML = 'Regresar a Zonas';
	    controlText.style.color = 'rgb(86,86,86)';
	    controlText.style.fontWeight = '400';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '15px';
        controlText.style.lineHeight = '18px';
        controlText.style.padding = '8px';

	    controlUI.appendChild(controlText);

	    // Setup the click event listeners:
	    controlUI.addEventListener('click', function() {

	    	api.options.mapZonePolygon.setMap(null);
			__clearMarkers();
			google.maps.event.trigger(api.options.map, 'resize');
			api.options.map.controls[google.maps.ControlPosition.TOP_CENTER].clear();
			__showMapZoneMarkers();
	    });
	    return this;
	}
	function __polyContainsLocation(marker, polygon)  {

		var hotelGoogleMapsMarker = new google.maps.Marker({
	          position: { lat : marker.latitude, lng : marker.longitude },
	    });

		return google.maps.geometry.poly.containsLocation(
				hotelGoogleMapsMarker.position, polygon)
	}

	function __getZonePolycoords(zone) {

		var polycoords = [];
		zone.area.forEach(function(areaPoint) {
			polycoords.push({
			    lat : areaPoint.latitude,
			    lng : areaPoint.longitude
			});

		});
		return polycoords;
	}

	function __initZones(zones) {

		_.forEach(zones, function ( zone ) {

			var polycoords = __getZonePolycoords(zone);

			var zoneBounds = new google.maps.LatLngBounds();
			polycoords.forEach(function(coordenada) {
				zoneBounds.extend(new google.maps.LatLng(coordenada));
			});

			var zonePolygon = new google.maps.Polygon({
			    paths : polycoords,
			    strokeColor : api.options.colorZonePoly,
			    strokeOpacity : 0.8,
			    strokeWeight : api.options.lineZoneWeight,
			    fillColor : api.options.colorZonePoly,
			    fillOpacity : 0.05
			});

			var zoneHotelMarkers = [];
			_.forEach(api.options.markers, function ( marker ) {
				if(__polyContainsLocation(marker, zonePolygon)) {

					zoneHotelMarkers.push(marker);
				}
			});

			api.options.mapZones.push({
			    code : zone.code,
			    name : zone.name,
			    quantity: zone.quantity,
			    latitude : zone.latitude,
			    longitude : zone.longitude,
			    hotelMarkers : zoneHotelMarkers,
			    polygon : zonePolygon,
			    zoneBounds: zoneBounds
			});

		});
	}

	function __initListeners() {
		$('.js-show-map').magnificPopup({
			callbacks : {
				open : function() {
					google.maps.event.trigger(api.options.map, 'resize');
				}
			}
		});
	}

	function __initMap( mapZones ) {

		if (_.isArray(mapZones)) {
			api.options.markerTooltip = $(api.options.markerTooltipSelector);
			var wrapper = document.getElementById(api.options.mapId)
			if (wrapper) {
				api.options.map = new google.maps.Map( wrapper, {
					zoom: 4,
					center : {
						lat : 0.0,
					    lng : 0.0
					}
			    });

				__initMapZoneMarkers(mapZones);

				api.options.map.addListener('resize', function() {
					var bounds = new google.maps.LatLngBounds();
					_.forEach(api.options.zoneGoogleMapsMarkers, function( zoneGoogleMapsMarkers ) {

						bounds.extend(zoneGoogleMapsMarkers.position);
					});
					api.options.map.fitBounds(bounds);
				});
			}
		}

	}

	function __initMapZoneMarkers(mapZones) {

		_.forEach(mapZones, function( mapZone ) {
			var zoneGoogleMapsMarker = new google.maps.Marker({
		          position: { lat : mapZone.latitude, lng : mapZone.longitude },
		          map: api.options.map,
		          label: {
		        	  text: mapZone.quantity.toString(),
		        	  color: "#FFFFFF"
		          },
		          icon: {
		              path: google.maps.SymbolPath.CIRCLE,
		              fillColor: api.options.colorZoneMarkerFill,
		              fillOpacity: 1,
		              strokeColor: api.options.colorZoneMarkerStroke,
		              scale: 13
		          }
		    });

			zoneGoogleMapsMarker.addListener( 'click', function() {
				__updateMapPorZona(mapZone);
			});

			zoneGoogleMapsMarker.addListener( 'mouseover', function() {
				var point = __convertLatLngToPoint( zoneGoogleMapsMarker.getPosition(), api.options.map);
			    api.options.markerTooltip.html( __getZoneMarkerTooltip( mapZone ) ).css({
					'left' : point.x,
					'top' : point.y
			    }).show();
			});
			zoneGoogleMapsMarker.addListener( 'mouseout', function() {
				api.options.markerTooltip.hide();
			});

			api.options.zoneGoogleMapsMarkers.push(zoneGoogleMapsMarker);
		});
	}

	function __showMapZoneMarkers() {

		_.forEach(api.options.zoneGoogleMapsMarkers, function( zoneGoogleMapsMarker ) {
			zoneGoogleMapsMarker.setMap(api.options.map);
		});
	}

	function __getZoneMarkerTooltip( mapZone ) {
		if ( mapZone ) {
			return "<strong>" + mapZone.name + "</strong>: ";
		}
	}

	function __getMarkerTooltip( marker ) {
		if ( marker ) {
			return "<strong>" + marker.name + "</strong>";
		}
	}

	function __clearMarkers() {

		api.options.markerTooltip.hide();
		_.forEach(api.options.zoneGoogleMapsMarkers, function( zoneGoogleMapsMarker ) {
			zoneGoogleMapsMarker.setMap(null);
		});

		_.forEach(api.options.hotelGoogleMapsMarkers, function( hotelGoogleMapsMarker ) {
			hotelGoogleMapsMarker.setMap(null);
		});
		// Vaciar el array de marcadores de hoteles
		api.options.hotelGoogleMapsMarkers = [];
	}

	function __updateMapPorZona( mapZone ) {

		__clearMarkers();

		var centerControlDiv = document.createElement('div');
		__centerControl(centerControlDiv);
		centerControlDiv.index = 1;
		api.options.map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);

		mapZone.polygon.setMap(api.options.map);
		api.options.mapZonePolygon = mapZone.polygon;

		_.forEach(mapZone.hotelMarkers, function( hotelMarker ) {

			var hotelGoogleMapsMarker = new google.maps.Marker({
		          position: { lat : hotelMarker.latitude, lng : hotelMarker.longitude },
		          map: api.options.map,
		          icon: '/sltwww/st2/images/soloHotel/pinblue.png'
		    });

			hotelGoogleMapsMarker.addListener( 'click', function() {
				__getMarkerInfoWindow( hotelMarker ).open(api.options.map, hotelGoogleMapsMarker);
			});

			hotelGoogleMapsMarker.addListener( 'mouseover', function() {
				var point = __convertLatLngToPoint( hotelGoogleMapsMarker.getPosition(), api.options.map);
			    api.options.markerTooltip.html( __getMarkerTooltip( hotelMarker ) ).css({
					'left' : point.x,
					'top' : point.y
			    }).show();
			});
			hotelGoogleMapsMarker.addListener( 'mouseout', function() {
				api.options.markerTooltip.hide();
			});

			api.options.hotelGoogleMapsMarkers.push(hotelGoogleMapsMarker);
		});

		api.options.map.fitBounds(mapZone.zoneBounds);
	}
	
	function __convertLatLngToPoint(latLng, map) {
	    var topRight = map.getProjection().fromLatLngToPoint(
		    map.getBounds().getNorthEast());
	    var bottomLeft = map.getProjection().fromLatLngToPoint(
		    map.getBounds().getSouthWest());
	    var scale = Math.pow(2, map.getZoom());
	    var worldPoint = map.getProjection().fromLatLngToPoint(latLng);
	    return new google.maps.Point((worldPoint.x - bottomLeft.x) * scale,
		    (worldPoint.y - topRight.y) * scale);
	}
	
	function __getMarkerInfoWindow( marker ) {
		var template = _.template($(api.options.infoWindowTemplateSelector).html()); 
		api.options.infoWindow = api.options.infoWindow || new google.maps.InfoWindow({
			maxWidth : 250
		});
		api.options.infoWindow.setContent(template({
			marker : marker
		}));
		return api.options.infoWindow;
	}
})();
var com = com || {};
com.grupopinero = com.grupopinero || {};
com.grupopinero.octopus = com.grupopinero.octopus || {};
com.grupopinero.octopus.packages = com.grupopinero.octopus.packages || {};
com.grupopinero.octopus.packages.availability = com.grupopinero.octopus.packages.availability || {};
com.grupopinero.octopus.packages.availability.DelayedAvailability = (function(){
	'use strict'
	
	let __import = {
		webUtils : com.grupopinero.octopus.packages.common.Utils,
		utils : com.grupopinero.octopus.helper.common.Utils,
		modals: com.grupopinero.octopus.helper.common.Modals
	};
	
	let api = {
		options : {
			sorryImage : 'https://static.grupo-pinero.com/web-static/images/sorry3.png'
		},
		init : __init,
		initSearchingAvail : initSearchingAvail
	}
	
	let priceInterval;
	
	return api;
	
	function __init(options, literals) {
		api.options = $.extend(true, api.options, options);
		api.literals = $.extend(true, api.literals, literals);

		__initDelayedAvail();

	}
	
	function __initDelayedAvail()
	{
		if(api.options.delayedAvailActive){
			initSearchingAvail();
			updateAvail();
		}
	}
	
	function initSearchingAvail()
	{
		$('.inputFilterChecked').each(function(){
			$(this).prop('checked', true);
			var name = $(this).attr('name').replace('[]','\\[\\]');
			var $formConnection = $(this).closest('form');
			var $checkboxAll = $formConnection.find('.js-filter-checkbox-all[name='+name+']');
			$checkboxAll.prop('checked', false)
			$checkboxAll.attr('disabled', false);
		})
		$('.js-quote-budget').attr("disabled", true);
		$('.js-recommended-flight').removeClass('u-display-none');
		$('#filtersContent :input').attr("disabled", true);
		$('.c-info__icon').off('click');
		$('.c-flight-details').off('click');
		$('.c-checkbox :input').attr("disabled", true);
		$('#hotelPageSelected').removeAttr( 'href' );
		$('#hotelPageSelected').off();
		$('#hotelPageSelected').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.js-change-order').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.js-go-to-hotel-details').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.c-hotels-filters__grid-item').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.js-change-hotels-page').bind('click', function(e){
		        e.preventDefault();
		        $(this).prop('disabled',true);
		});
		$('.c-recommended').each(function(){
			$(this).addClass( 'u-display-none' );
		});
		
		$('.c-pagination__link').each(function(){
			$(this).css('cursor', 'not-allowed');
		});
		
		$('#hotelFiltersForm_hotelCodes').prop('disabled', true);
		
		$.notify.defaults({
			position: 'top center',
			style : 'bootstrap',
			className: 'error'
		});
		
		$.notify( api.literals['AVAILABILITY.FORM.LOADING'], {
		  className: 'none js-loading-prices',
		  autoHide: false,
		  clickToHide: false
		});
		
		function blink_text() {
			$('.js-loading-prices').each(function(){
				$(this).removeClass( 'u-display-none' );
				$(this).fadeOut(1000);
				$(this).fadeIn(1000);
			});
		}
		priceInterval = setInterval(blink_text, 1000);
	}
		
		function updateAvail(){
			try {
				let rq = api.options.availRq;
				rq.forceAvail = true;
				rq.catalogueHotelCodes = api.options.catalogueHotelCodes;
				rq.catalogueHotels = api.options.catalogueHotels;
				rq.hotelTotalCount = api.options.hotelTotalCount;
				rq.hotelTotalCountInFilter = api.options.hotelTotalCountInFilter;
				$.ajax({
					type : 'post',
					url : __import.webUtils.routes().availability.delayed,
					data : {rq : JSON.stringify(rq)},
					dataType : 'json',
					success : function(response) {
						if (response && response.result && response.result.ok) {
							clearPrice();
							__clearLoadingToast();
							$('#availContent').replaceWith(response.availHtml);
							$('#tracePop')[0].dataset.traceToken = response.traceToken;
							window.app.init('#availContent');
							let jsInit = response.jsInit;
							if (jsInit) {
								eval(jsInit);
							}
							$('.hasNoPrice').each(function(){
								$(this).css('opacity', '0.7');
							});
							$('.unavailable_hotel').each(function(){
								$(this).removeClass( 'u-display-none' );
							});
							let selectsAux = window.selects;
							window.selects = [];
							window.app.selectSearch();
							var g = Object.keys(window.selects)
					        for(var y of g)
					    	{
					        	if(y=='hotelFiltersForm_hotelCodes'){
					        		selectsAux[y] = window.selects[y];					        		
					        	}
					    	}
					        window.selects = selectsAux;
					        var state = new URLSearchParams(window.location.search).get('state');
							if(state==null){
								window.history.replaceState("", "", "/package/process/availability/Availability?availToken=" + response.availToken + "&state=1");
							}
							else{
								state = +state+1;
								window.history.replaceState("", "", "/package/process/availability/Availability?availToken=" + response.availToken + "&state=" + state);
							}	
						}else{
							__clearLoadingToast()
							__showAvailabilityModalError();
						}
					},
					error : function(response) {
						__clearLoadingToast()
						__showAvailabilityModalError();
					},
				});	

			} catch (e) {
				__clearLoadingToast()
				__showAvailabilityModalError();
			}
		}
		
		function clearPrice(){
			clearInterval(priceInterval);
			$('.loadingPrices').each(function(){
				$(this).addClass( 'u-display-none' );
			});
			$('.c-calendar__content .c-checkbox :input').attr("disabled", false);
			$('.c-pagination__link').each(function(){
				$(this).css('cursor', 'pointer');
			});
		}
		
		function __showAvailabilityModalError() {
			var dialog = { 
					image : api.options.sorryImage, 
					text: api.literals['AVAILABILITY.CATALOGUE.ERROR.NO_DISPO'], 
					buttons : [ 
						{ 
							label : api.literals['COMMON.GO_BACK'], 
							events : {
								click : function () {
									var rq = api.options.availRq;
									__import.utils.spinner.show();
									__import.utils.forms.submitRequestForm( rq, __import.webUtils.routes().home);
								}
							}
						} ] };
				__import.modals.dialog(dialog);
		}
		
		function __clearLoadingToast() {
			$('.js-loading-prices').closest('.notifyjs-wrapper').trigger('notify-hide');
		}
})();